<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azərbaycan Beynəlxalq Maarif Məktəbləri - 2025-2026 Tədris ili I yarımil analizi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #00525d;
            --secondary-blue: #00adba;
            --accent-blue: #4fd1c5;
            --light-blue: #e6f7ff;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
            --dark-gray: #374151;
            --light-gray: #f9fafb;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            color: var(--dark-gray);
            padding-top: 60px !important;
        }

        /* IMSA Stili Header */
        .navbar-imsa {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            box-shadow: 0 4px 20px rgba(0, 82, 93, 0.15);
            padding: 0.5rem 0;
            backdrop-filter: blur(10px);
        }

        .navbar-brand-imsa {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: white !important;
            text-decoration: none;
            gap: 12px;
        }

        .logo-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: white;
            padding: 2px;
        }

        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }

        .school-name {
            display: flex;
            flex-direction: column;
        }

        .school-name-main {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .school-name-sub {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Sistem Məlumat Kartı */
        .system-info-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        /* Mobil Optimizasiya */
        @media (max-width: 768px) {
            body {
                padding-top: 110px !important;
            }
            
            .mobile-compact-nav {
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                background: white;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 0.75rem;
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .mobile-compact-nav::-webkit-scrollbar {
                display: none;
            }
            
            .mobile-nav-btn {
                flex: 0 0 auto;
                padding: 0.5rem 1rem;
                margin: 0 0.25rem;
                background: var(--light-blue);
                border: 2px solid transparent;
                border-radius: 8px;
                color: var(--primary-blue);
                font-weight: 500;
                font-size: 0.85rem;
                white-space: nowrap;
                transition: all 0.3s ease;
            }
            
            .mobile-nav-btn.active {
                background: var(--primary-blue);
                color: white;
                border-color: var(--accent-blue);
            }
            
            .mobile-nav-btn i {
                margin-right: 0.5rem;
                font-size: 0.9rem;
            }
            
            .content-section {
                margin-top: 120px !important;
                padding: 1rem !important;
            }
            
            .stat-card {
                padding: 1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .stat-card h3 {
                font-size: 1.5rem !important;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }

            .navbar-brand-imsa {
                font-size: 0.9rem;
            }

            .logo-circle {
                width: 40px;
                height: 40px;
            }
        }

        /* Desktop Sidebar */
        @media (min-width: 769px) {
            .desktop-sidebar {
                background: linear-gradient(180deg, var(--primary-blue) 0%, #003f47 100%);
                min-height: calc(100vh - 60px);
                position: sticky;
                top: 60px;
                box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
            }
            
            .sidebar-nav {
                padding: 1.5rem 0;
            }
            
            .sidebar-nav .nav-link {
                color: rgba(255, 255, 255, 0.9);
                padding: 0.75rem 1.5rem;
                margin: 0.25rem 1rem;
                border-radius: 8px;
                transition: all 0.3s ease;
                font-weight: 500;
            }
            
            .sidebar-nav .nav-link:hover,
            .sidebar-nav .nav-link.active {
                background: rgba(255, 255, 255, 0.15);
                color: white;
                transform: translateX(5px);
            }
            
            .sidebar-nav .nav-link i {
                width: 24px;
                text-align: center;
                margin-right: 10px;
            }
        }

        /* İstatistik Kartları */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-card.blue {
            border-left: 4px solid var(--secondary-blue);
        }

        .stat-card.green {
            border-left: 4px solid var(--success-green);
        }

        .stat-card.orange {
            border-left: 4px solid var(--warning-orange);
        }

        .stat-card.red {
            border-left: 4px solid var(--danger-red);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary-blue);
        }

        /* Kartlar */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            background: white;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }

        /* Cədvəllər */
        .data-table th {
            background: var(--light-blue);
            color: var(--primary-blue);
            font-weight: 600;
            padding: 1rem;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background-color: var(--light-gray);
        }

        /* Davamsızlq İndikatorları */
        .attendance-low { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-red); }
        .attendance-medium { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-orange); }
        .attendance-good { background-color: rgba(16, 185, 129, 0.1); color: var(--success-green); }
        .attendance-excellent { background-color: rgba(79, 209, 197, 0.1); color: var(--accent-blue); }

        .attendance-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        /* Proqress Barları */
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
        }

        .progress-custom .progress-bar {
            border-radius: 4px;
        }

        /* Filtre Bölməsi */
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        /* Analiz Qrafikləri */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Şagird Profil Şəkli - Məktəb Logosu */
        .student-photo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: white;
            padding: 2px;
        }

        .student-photo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Mobil Üçün Xüsusi */
        .mobile-only { display: none; }
        .desktop-only { display: block; }

        @media (max-width: 768px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }

        /* Yeni: Info Kartları */
        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .info-card h6 {
            color: var(--primary-blue);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Yeni: Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .quick-stat-item {
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .quick-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .quick-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-imsa navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand-imsa" href="#">
                <div class="logo-circle">
                    <img src="https://i.imgur.com/a3FuVV8.png" alt="IMSA Logo" 
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/00525d/ffffff?text=IMSA';">
                </div>
                <div class="school-name">
                    <div class="school-name-main">Azərbaycan Beynəlxalq Maarif Məktəbləri - Nəsimi kampusu</div>
                    <div class="school-name-sub">2025-2026 Tədris ili I yarımil analizi</div>
                </div>
            </a>
            <div class="navbar-text text-white ms-auto">
                <span id="current-date" style="font-size: 0.9rem;"></span>
            </div>
        </div>
    </nav>

    <!-- Mobil Navigasiya (Kompaqt) -->
    <div class="mobile-only mobile-compact-nav" id="mobile-nav">
        <button class="mobile-nav-btn active" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i>Ümumi
        </button>
        <button class="mobile-nav-btn" data-section="students">
            <i class="fas fa-users"></i>Şagirdlər
        </button>
        <button class="mobile-nav-btn" data-section="attendance">
            <i class="fas fa-calendar-alt"></i>Davamsızlıq
        </button>
        <button class="mobile-nav-btn" data-section="subjects">
            <i class="fas fa-book"></i>Fənlər
        </button>
        <button class="mobile-nav-btn" data-section="classes">
            <i class="fas fa-chalkboard"></i>Siniflər
        </button>
        <button class="mobile-nav-btn" data-section="comparison">
            <i class="fas fa-balance-scale"></i>Müqayisə
        </button>
        <button class="mobile-nav-btn" data-section="export">
            <i class="fas fa-download"></i>Rapor
        </button>
    </div>

    <div class="container-fluid" style="margin-top: 60px;">
        <div class="row">
            <!-- Desktop Sidebar -->
            <div class="col-lg-2 desktop-only desktop-sidebar">
                <div class="sidebar-nav">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i> Ümumi Görünüş
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="students">
                                <i class="fas fa-users"></i> Şagird Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="attendance">
                                <i class="fas fa-calendar-alt"></i> Davamsızlıq Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="subjects">
                                <i class="fas fa-book"></i> Fənn Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="classes">
                                <i class="fas fa-chalkboard"></i> Sinif Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="comparison">
                                <i class="fas fa-balance-scale"></i> Müqayisə Analizi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="export">
                                <i class="fas fa-file-download"></i> Rapor Yüklə
                            </a>
                        </li>
                    </ul>

                    <!-- Sistem Məlumat Kartı -->
                    <div class="system-info-card mt-4">
                        <h6><i class="fas fa-info-circle me-2"></i>Sistem Məlumatı</h6>
                        <div class="mt-3">
                            <div id="data-info">Gömülü verilər (2-9. siniflər)</div>
                            <div id="last-update" class="mt-2">Son yeniləmə: -</div>
                        </div>
                        <div class="quick-stats">
                            <div class="quick-stat-item">
                                <div class="quick-stat-value" id="quick-total-students">0</div>
                                <div class="quick-stat-label">Şagird</div>
                            </div>
                            <div class="quick-stat-item">
                                <div class="quick-stat-value" id="quick-total-classes">0</div>
                                <div class="quick-stat-label">Sinif</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-12 p-3 p-lg-4">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section">
                    <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>Ümumi Görünüş</h2>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6">
                            <div class="stat-card blue">
                                <i class="fas fa-users"></i>
                                <h3 id="total-students">0</h3>
                                <p>Ümumi Şagird</p>
                                <small class="text-muted" id="total-classes-info">0 sinif</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card green">
                                <i class="fas fa-chart-line"></i>
                                <h3 id="overall-average">0.0</h3>
                                <p>Ümumi Ortalama</p>
                                <small class="text-muted" id="average-trend">Normal</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card orange">
                                <i class="fas fa-calendar-times"></i>
                                <h3 id="avg-attendance">0.0</h3>
                                <p>Orta Davamsızlıq</p>
                                <small class="text-muted" id="attendance-status">Yaxşı</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card red">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3 id="warning-students">0</h3>
                                <p>Diqqət Yetirilməli</p>
                                <small class="text-muted" id="warning-info">Nəzərə alınmalı</small>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-3 mb-lg-0">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i>Fənn Ortalamaları (Top 8)
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="subjectAvgChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-user-clock me-2"></i>Davamsızlıq Statistikası
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="attendanceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Students & Alerts -->
                    <div class="row">
                        <div class="col-lg-6 mb-3 mb-lg-0">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-trophy me-2"></i>Ən Yüksək Nəticəli 5 Şagird
                                </div>
                                <div class="card-body">
                                    <div id="top-students-list">
                                        <p class="text-muted">Yüklənir...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning">
                                    <i class="fas fa-exclamation-circle me-2"></i>Diqqət Yetirilməli Olanlar
                                </div>
                                <div class="card-body">
                                    <div id="warning-students-list">
                                        <p class="text-muted">Yüklənir...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Students Analysis Section -->
                <section id="students-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-users me-2"></i>Şagird Analizi</h2>

                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="student-class-filter" class="form-label">Sinif seçin:</label>
                                <select id="student-class-filter" class="form-select">
                                    <option value="all">Hamısı</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="student-search" class="form-label">Şagird axtarın:</label>
                                <input type="text" id="student-search" class="form-control" placeholder="Ad, soyad...">
                            </div>
                            <div class="col-md-4">
                                <label for="student-sort" class="form-label">Sırala:</label>
                                <select id="student-sort" class="form-select">
                                    <option value="name">Ada görə</option>
                                    <option value="average_desc">Ortalamaya görə (azalan)</option>
                                    <option value="average_asc">Ortalamaya görə (artan)</option>
                                    <option value="attendance_desc">Davamsızlığa görə (azalan)</option>
                                    <option value="attendance_asc">Davamsızlığa görə (artan)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list me-2"></i>Şagird Siyahısı</span>
                            <span id="student-count" class="badge bg-primary">0 şagird</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table data-table table-hover mb-0" id="students-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Şagird</th>
                                            <th>Sinif</th>
                                            <th>Ümumi Orta</th>
                                            <th>Davamsızlıq</th>
                                            <th>Status</th>
                                            <th>Əməliyyat</th>
                                        </tr>
                                    </thead>
                                    <tbody id="students-table-body">
                                        <!-- Data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Attendance Analysis Section -->
                <section id="attendance-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-calendar-alt me-2"></i>Davamsızlıq Analizi</h2>

                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="attendance-class-filter" class="form-label">Sinif seçin:</label>
                                <select id="attendance-class-filter" class="form-select">
                                    <option value="all">Hamısı</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="attendance-threshold" class="form-label">Davamsızlıq həddi:</label>
                                <select id="attendance-threshold" class="form-select">
                                    <option value="5">5+ gün (Yüksək)</option>
                                    <option value="10">10+ gün (Çox yüksək)</option>
                                    <option value="15">15+ gün (Təhlükəli)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Stats -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-user-check fa-2x text-success mb-3"></i>
                                    <h4 id="good-attendance-count">0</h4>
                                    <p class="text-muted">Yaxşı Davamsızlıq (0-4 gün)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-user-clock fa-2x text-warning mb-3"></i>
                                    <h4 id="medium-attendance-count">0</h4>
                                    <p class="text-muted">Orta Davamsızlıq (5-9 gün)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-user-times fa-2x text-danger mb-3"></i>
                                    <h4 id="high-attendance-count">0</h4>
                                    <p class="text-muted">Yüksək Davamsızlıq (10+ gün)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Class-based Attendance -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Sinif Bazlı Davamsızlıq Ortalaması
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="classAttendanceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance List -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list me-2"></i>Davamsızlıq Siyahısı</span>
                            <span id="attendance-count" class="badge bg-primary">0 şagird</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table data-table table-hover mb-0" id="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>Şagird</th>
                                            <th>Sinif</th>
                                            <th>Davamsızlıq (gün)</th>
                                            <th>Ümumi Orta</th>
                                            <th>Davamsızlıq Statusu</th>
                                            <th>Əks Təsir</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-table-body">
                                        <!-- Data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Subjects Analysis Section -->
                <section id="subjects-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-book me-2"></i>Fənn Analizi</h2>

                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="subject-class-filter" class="form-label">Sinif seçin:</label>
                                <select id="subject-class-filter" class="form-select">
                                    <option value="all">Hamısı</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="subject-grade-filter" class="form-label">Sinif səviyyəsi:</label>
                                <select id="subject-grade-filter" class="form-select">
                                    <option value="all">Hamısı</option>
                                    <option value="2">2-ci sinif</option>
                                    <option value="3">3-cü sinif</option>
                                    <option value="4">4-cü sinif</option>
                                    <option value="5">5-ci sinif</option>
                                    <option value="6">6-cı sinif</option>
                                    <option value="7">7-ci sinif</option>
                                    <option value="8">8-ci sinif</option>
                                    <option value="9">9-cu sinif</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="subject-sort" class="form-label">Sırala:</label>
                                <select id="subject-sort" class="form-select">
                                    <option value="name">Ada görə</option>
                                    <option value="average_desc">Ortalamaya görə (azalan)</option>
                                    <option value="average_asc">Ortalamaya görə (artan)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-star fa-2x text-warning mb-3"></i>
                                    <h4 id="best-subject">-</h4>
                                    <p class="text-muted">Ən Yüksək Ortalamalı Fənn</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-chart-line fa-2x text-primary mb-3"></i>
                                    <h4 id="subject-total-count">0</h4>
                                    <p class="text-muted">Analiz Edilən Fənn Sayı</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                                    <h4 id="worst-subject">-</h4>
                                    <p class="text-muted">Ən Aşağı Ortalamalı Fənn</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i>Fənn Statistikaları
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table data-table table-hover" id="subjects-table">
                                    <thead>
                                        <tr>
                                            <th>Fənn</th>
                                            <th>Ümumi Orta</th>
                                            <th>2-ci Sinif</th>
                                            <th>3-cü Sinif</th>
                                            <th>4-cü Sinif</th>
                                            <th>5-ci Sinif</th>
                                            <th>6-cı Sinif</th>
                                            <th>7-ci Sinif</th>
                                            <th>8-ci Sinif</th>
                                            <th>9-cu Sinif</th>
                                            <th>Uğur Nisbəti</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subjects-table-body">
                                        <tr><td colspan="11" class="text-center text-muted">Yüklənir...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Correlation Chart -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Fənn Ortalamaları Qrafiki
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="subjectComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Classes Analysis Section -->
                <section id="classes-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-chalkboard-teacher me-2"></i>Sinif Analizi</h2>

                    <div class="row mb-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i>Sinif Ortalamaları və Davamsızlıq
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="classAvgChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-trophy me-2"></i>Ən Yüksək Ortalamalı 3 Sinif
                                </div>
                                <div class="card-body" id="top-classes-list">
                                    <p class="text-muted">Yüklənir...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-table me-2"></i>Sinif Müqayisəsi
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table data-table table-hover" id="classes-table">
                                    <thead>
                                        <tr>
                                            <th>Sinif</th>
                                            <th>Şagird Sayı</th>
                                            <th>Ümumi Orta</th>
                                            <th>Davamsızlıq (orta)</th>
                                            <th>Ən Yaxşı Fənn</th>
                                            <th>Ən Aşağı Fənn</th>
                                            <th>Uğurlu Şagird (%)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="classes-table-body">
                                        <tr><td colspan="8" class="text-center text-muted">Yüklənir...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Comparison Section -->
                <section id="comparison-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-balance-scale me-2"></i>Müqayisə Analizi</h2>

                    <div class="row mb-4">
                        <div class="col-lg-6 mb-3 mb-lg-0">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i>Sinif Səviyyəsinə Görə Müqayisə
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="gradeComparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="fas fa-chart-line me-2"></i>Davamsızlıq və Ortalama Əlaqəsi
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="attendanceCorrelationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-table me-2"></i>Detallı Müqayisə
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table data-table table-hover" id="comparison-table">
                                    <thead>
                                        <tr>
                                            <th>Göstərici</th>
                                            <th>2-ci Sinif</th>
                                            <th>3-cü Sinif</th>
                                            <th>4-cü Sinif</th>
                                            <th>5-ci Sinif</th>
                                            <th>6-cı Sinif</th>
                                            <th>7-ci Sinif</th>
                                            <th>8-ci Sinif</th>
                                            <th>9-cu Sinif</th>
                                            <th>Qalib Sinif</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparison-table-body">
                                        <tr><td colspan="10" class="text-center text-muted">Yüklənir...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Export Section -->
                <section id="export-section" class="content-section" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-file-download me-2"></i>Rapor Yüklə</h2>

                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    <h4>PDF Rapor</h4>
                                    <p class="text-muted">Ümumi statistikalar ilə PDF formatında</p>
                                    <button class="btn btn-danger w-100" onclick="exportPDF()">
                                        <i class="fas fa-download me-2"></i>PDF Yüklə
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                    <h4>Excel Rapor</h4>
                                    <p class="text-muted">Analiz məlumatları ilə Excel formatında</p>
                                    <button class="btn btn-success w-100" onclick="exportExcel()">
                                        <i class="fas fa-download me-2"></i>Excel Yüklə
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                    <h4>Şəkillər</h4>
                                    <p class="text-muted">Bütün qrafikləri PNG formatında</p>
                                    <button class="btn btn-primary w-100" onclick="exportCharts()">
                                        <i class="fas fa-download me-2"></i>Şəkilləri Yüklə
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rapor Seçimləri -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-cogs me-2"></i>Rapor Konfiqurasiyası
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="include-charts" checked>
                                        <label class="form-check-label" for="include-charts">
                                            <i class="fas fa-chart-bar me-2"></i>Qrafikləri daxil et
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="include-attendance" checked>
                                        <label class="form-check-label" for="include-attendance">
                                            <i class="fas fa-calendar-alt me-2"></i>Davamsızlıq analizini daxil et
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="include-recommendations" checked>
                                        <label class="form-check-label" for="include-recommendations">
                                            <i class="fas fa-lightbulb me-2"></i>Tövsiyələri daxil et
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="include-details" checked>
                                        <label class="form-check-label" for="include-details">
                                            <i class="fas fa-info-circle me-2"></i>Detalları daxil et
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modal for Student Details -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle">Şagird Detalları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentModalBody">
                    <!-- Student details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bağla</button>
                    <button type="button" class="btn btn-primary" onclick="printStudentReport()">
                        <i class="fas fa-print me-2"></i>Çap et
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // GÖMÜLÜ EXCEL VERİLERİ
        // =============================================
        const embeddedExcelData = {
            // 2-4. sınıflar
            '2-4': [
                ["Şagird", "Sinif", "Davamsızlıq sayı", "Azərbaycan dili", "Riyaziyyat", "Həyat bilgisi", "İngilis dili", "Rus dili", "Türk dili", "İnformatika", "Texnologiya", "Musiqi", "Təsviri İncəsənət", "Fiziki tərbiyə"],
                ["Ağazadə İbrahim", "2.A", 9, 65, 61, 72, 24, 51, 78, 81, 88, 63, 100, 88],
                ["Aslanlı Mədinə", "2.A", 5, 88, 84, 80, 73, 87, 84, 82, 89, 97, 92, 87],
                ["Aslanlı Məryəm", "2.A", 2, 89, 94, 70, 86, 95, 93, 86, 91, 97, 92, 89],
                ["Aslanlı Murad", "2.A", 4, 82, 94, 77, 88, 89, 96, 90, 89, 92, 97, 91],
                ["Baxışov Kənan", "2.A", 10, 55, 79, 85, 27, 35, 63, 81, 65, 82, 88, 89],
                ["Əmirli İbrahim", "2.A", 3, 92, 94, 85, 80, 81, 86, 84, 88, 62, 87, 85],
                ["Əsədli İdel", "2.A", 1, 98, 94, 90, 80, 95, 92, 95, 99, 100, 100, 89],
                ["Hacıyev Yusub", "2.A", 2, 94, 92, 90, 59, 92, 93, 90, 96, 74, 92, 91],
                ["İskəndərzadə Rafiq", "2.A", 6, 77, 86, 77, 79, 68, 80, 86, 81, 97, 90, 89],
                ["Qafarzadə Hüseyn", "2.A", 2, 96, 92, 86, 72, 81, 95, 95, 97, 78, 100, 90],
                ["Mönsüm Yunus", "2.A", 8, 80, 90, 89, 63, 67, 86, 78, 95, 78, 95, 86],
                ["Muradov Tuncay", "2.A", 4, 93, 94, 88, 80, 83, 87, 90, 95, 78, 100, 89],
                ["Nizamova İnci", "2.A", 2, 97, 67, 79, 53, 81, 83, 84, 87, 93, 92, 88],
                ["Rəsulov Rauf", "2.A", 5, 93, 97, 87, 84, 82, 94, 91, 88, 78, 97, 90],
                ["Vəlizadə Gülnarə", "2.A", 10, 95, 97, 89, 62, 92, 92, 89, 93, 97, 93, 89],
                ["Zülfüqarlı Mədinə", "2.A", 2, 80, 77, 74, 63, 91, 85, 80, 91, 97, 100, 89],
                ["Babayev Uğur", "2.B", 15, 95, 97, 87, 96, 84, 84, 89, 95, 82, 83, 92],
                ["Əliyeva Miray", "2.B", 10, 93, 91, 85, 95, 90, 87, 83, 98, 85, 100, 94],
                ["Əsədullayeva Zəhra", "2.B", 5, 90, 89, 87, 77, 74, 91, 87, 100, 82, 82, 91],
                ["Göyüşzadə Ahu", "2.B", 9, 31, 34, 40, 12, 39, 52, 66, 55, 67, 100, 84],
                ["Həsənli Rəcəb", "2.B", 4, 60, 55, 52, 42, 60, 63, 70, 70, 67, 80, 82],
                ["Həsənzadə Hiranur", "2.B", 4, 80, 86, 89, 78, 85, 87, 91, 93, 93, 100, 90],
                ["Hüseynov İbrahim", "2.B", 1, 91, 98, 90, 74, 73, 94, 89, 95, 93, 82, 97],
                ["İbrahimli Mikayıl", "2.B", 4, 87, 90, 86, 95, 98, 85, 88, 98, 80, 90, 93],
                ["Quliyeva Səma", "2.B", 16, 88, 81, 94, 98, 84, 85, 79, 92, 90, 87, 89],
                ["Məmmədova Mədinə", "2.B", 5, 62, 64, 91, 77, 80, 86, 77, 94, 82, 90, 85],
                ["Məmmədzadə Süleyman", "2.B", 6, 100, 97, 92, 100, 82, 92, 91, 97, 79, 83, 88],
                ["Muxtarlı Sevinc", "2.B", 14, 88, 87, 85, 93, 87, 99, 90, 93, 87, 100, 90],
                ["Musayev Elşən", "2.B", 0, 94, 98, 82, 75, 78, 91, 95, 98, 77, 100, 92],
                ["Müslüm Zeynəb", "2.B", 1, 92, 85, 96, 84, 81, 89, 90, 98, 82, 100, 90],
                ["Nəsirova Aylin", "2.B", 4, 94, 75, 85, 85, 81, 83, 86, 97, 98, 82, 89],
                ["Nuriyev Atilla", "2.B", 5, 88, 97, 96, 95, 90, 78, 93, 98, 90, 82, 90],
                ["Səbizova Mehparə", "2.B", 2, 98, 100, 92, 92, 90, 88, 89, 98, 74, 92, 89],
                ["Allahverdi İsmail", "3.A", 9, 84, 80, 88, 43, 58, 87, 74, 84, 80, 73, 84],
                ["Cəfərzadə Suada", "3.A", 6, 96, 89, 95, 61, 93, 92, 87, 93, 85, 78, 85],
                ["Xankişiyev Fateh", "3.A", 2, 87, 64, 79, 81, 61, 81, 79, 78, 67, 77, 82],
                ["İmanlı Əli", "3.A", 2, 93, 89, 87, 53, 77, 87, 81, 95, 82, 78, 86],
                ["İsmayılova Aişə", "3.A", 1, 80, 47, 64, 20, 53, 63, 75, 70, 55, 77, 81],
                ["Qarayeva Zəhra", "3.A", 3, 51, 78, 74, 30, 93, 78, 73, 76, 50, 80, 83],
                ["Məmmədli Cəlal", "3.A", 3, 96, 93, 92, 84, 82, 87, 81, 93, 87, 97, 89],
                ["Məmmədzadə Əslinur", "3.A", 9, 89, 96, 88, 47, 79, 94, 91, 90, 87, 87, 94],
                ["Məmmədzadə Mahinur", "3.A", 6, 69, 44, 82, 44, 76, 86, 73, 70, 77, 80, 84],
                ["Muradlı Ömər", "3.A", 0, 87, 96, 81, 67, 76, 74, 79, 79, 55, 73, 97],
                ["Musayev Cəsur", "3.A", 0, 89, 91, 79, 33, 72, 75, 87, 88, 69, 75, 98],
                ["Novruzlu Xədicə", "3.A", 2, 84, 87, 81, 68, 79, 77, 81, 81, 65, 90, 83],
                ["Rəhimli Rüstəm", "3.A", 0, 96, 96, 88, 83, 96, 90, 88, 92, 98, 93, 84],
                ["Sərdar Mehdi", "3.A", 10, 49, 36, 56, 39, 94, 59, 70, 74, 52, 62, 85],
                ["Əliyeva İnci", "3.A", 8, 91, 89, 95, 73, 89, 85, 90, 80, 95, 100, 90],
                ["Əliyeva Şəms", "3.B", 6, 76, 76, 88, 60, 83, 83, 84, 75, 77, 95, 88],
                ["Əlizadə Hümeyra", "3.B", 13, 78, 78, 85, 59, 62, 87, 84, 73, 87, 87, 89],
                ["Əmirov Ali", "3.B", 14, 71, 96, 86, 53, 35, 86, 82, 70, 62, 80, 86],
                ["Hüseynzadə Enes", "3.B", 3, 89, 93, 97, 89, 91, 84, 91, 85, 80, 90, 89],
                ["Karauçoğlu Alparslan", "3.B", 11, 40, 51, 55, 82, 98, 88, 81, 70, 52, 83, 83],
                ["Kayıkçıoğlu Ömər Aras", "3.B", 19, 71, 73, 75, 75, 67, 78, 82, 74, 72, 93, 84],
                ["Kazım Mətin", "3.B", 4, 76, 87, 89, 45, 72, 84, 85, 78, 65, 93, 86],
                ["Qayıblı Altay", "3.B", 6, 93, 91, 83, 75, 86, 90, 85, 86, 87, 97, 98],
                ["Məmmədzadə Əhməd", "3.B", 9, 93, 100, 93, 87, 81, 85, 80, 89, 92, 97, 93],
                ["Musavi Həsən", "3.B", 2, 73, 87, 82, 72, 95, 90, 85, 75, 80, 80, 94],
                ["Səfərli Onur", "3.B", 4, 67, 69, 66, 68, 97, 82, 78, 60, 70, 73, 89],
                ["Vəli Dəfnə", "3.B", 8, 93, 89, 90, 90, 90, 84, 87, 89, 90, 93, 91],
                ["Bektaşoğlu Zelihanur", "4.A", 7, 72, 59, 89, 60, 64, 93, 87, 92, 80, 93, 90],
                ["Əliyeva Nəzakət", "4.A", 3, 88, 74, 85, 55, 45, 87, 85, 96, 74, 89, 84],
                ["Əsədli Zeynəb", "4.A", 2, 99, 90, 95, 65, 89, 94, 88, 99, 73, 93, 99],
                ["Hüseynzadə Melissa", "4.A", 5, 93, 82, 92, 89, 88, 100, 93, 99, 100, 96, 91],
                ["Xankişiyeva İlayda", "4.A", 2, 82, 65, 82, 78, 62, 87, 83, 98, 88, 100, 85],
                ["İbrahimov Ziya", "4.A", 2, 85, 92, 87, 76, 91, 81, 82, 98, 88, 84, 89],
                ["Quluzadə Murad", "4.A", 2, 70, 76, 77, 67, 90, 74, 86, 97, 63, 89, 87],
                ["Məmmədova Aylin", "4.A", 6, 84, 74, 89, 69, 91, 98, 86, 98, 92, 90, 89],
                ["Musavi Nüman", "4.A", 3, 87, 86, 94, 68, 85, 86, 87, 92, 58, 91, 90],
                ["Musayev Adil", "4.A", 0, 97, 98, 93, 55, 87, 88, 83, 98, 92, 94, 90],
                ["Musa-zadə Ayxan", "4.A", 6, 82, 69, 93, 45, 47, 85, 80, 97, 73, 86, 95],
                ["Vəlizadə İsmayıl", "4.A", 6, 86, 72, 85, 50, 67, 76, 75, 97, 90, 82, 95],
                ["Ağayeva Fidan", "4.B", 3, 72, 43, 79, 46, 94, 73, 74, 94, 77, 82, 81],
                ["Bayramov Uğur", "4.B", 1, 66, 54, 86, 69, 73, 84, 79, 83, 81, 93, 84],
                ["Göyüşzadə Ayan", "4.B", 21, 59, 25, 76, 25, 23, 65, 65, 94, 40, 71, 81],
                ["İbrahimova İpək", "4.B", 9, 78, 73, 91, 45, 71, 94, 81, 97, 78, 87, 83],
                ["Qəmbərli Zəhra", "4.B", 2, 85, 71, 86, 69, 83, 95, 85, 93, 88, 89, 86],
                ["Mehdizadə Aysel", "4.B", 6, 87, 78, 97, 75, 87, 99, 82, 86, 99, 91, 87],
                ["Məmmədli Emil", "4.B", 3, 77, 40, 84, 34, 45, 82, 75, 95, 56, 90, 86],
                ["Musayev Fateh", "4.B", 0, 90, 79, 92, 43, 70, 79, 91, 99, 85, 92, 90],
                ["Nəsirov Nihad", "4.B", 5, 84, 78, 88, 69, 70, 88, 84, 93, 64, 89, 82],
                ["Zülfüqarlı Hicran", "4.B", 1, 80, 53, 91, 50, 85, 85, 79, 89, 73, 88, 87]
            ],
            // 5. sınıf
            '5': [
                ["Şagird", "Sinif", "Davamsızlıq sayı", "Azərbaycan dili", "Ədəbiyyat", "Riyaziyyat", "İngilis dili", "Rus dili", "Türk dili", "İnformatika", "Texnologiya", "Təbiət", "Azərbaycan Tarixi", "Musiqi", "Təsviri İncəsənət", "Fiziki tərbiyə"],
                ["Ağazadə Zəhra", "5A", 3, 47, 73, 31, 39, 38, 82, 81, 85, 53, 40, 69, 73, 94],
                ["Baxışlı Suada", "5A", 9, 73, 87, 64, 82, 84, 88, 83, 88, 77, 63, 88, 78, 93],
                ["Çokal Elif Ece", "5A", 9, 68, 93, 80, 87, 38, 99, 92, 93, 83, 70, 93, 93, 90],
                ["Əbdülsalamova Müjgan", "5A", 5, 74, 87, 31, 68, 66, 90, 80, 84, 53, 37, 77, 88, 86],
                ["Əliyeva Banu", "5A", 6, 83, 93, 87, 88, 87, 86, 90, 90, 87, 57, 85, 89, 91],
                ["İmamzadə Xədicə", "5A", 0, 84, 87, 76, 77, 73, 82, 91, 91, 93, 70, 94, 90, 97],
                ["İsmayılov Çingiz", "5A", 7, 74, 93, 96, 84, 86, 82, 95, 95, 93, 80, 94, 92, 94],
                ["Karataş Elif Nur", "5A", 1, 56, 93, 59, 78, 68, 85, 91, 92, 83, 60, 86, 92, 94],
                ["Qasımova Aylin", "5A", 3, 84, 100, 70, 88, 75, 90, 95, 94, 100, 87, 100, 90, 89],
                ["Mehdizadə Fidan", "5A", 6, 53, 67, 42, 55, 78, 81, 81, 83, 50, 50, 65, 73, 88],
                ["Məmmədova Gülay", "5A", 15, 79, 73, 18, 42, 52, 79, 75, 82, 60, 30, 58, 75, 86],
                ["Məsimli Zeynəb", "5A", 2, 83, 67, 66, 64, 68, 89, 92, 93, 97, 67, 82, 90, 94],
                ["Musayev Fateh", "5A", 2, 79, 93, 83, 81, 67, 86, 93, 96, 80, 70, 84, 85, 90],
                ["Müslüm Məryəm", "5A", 1, 83, 87, 91, 86, 81, 98, 94, 94, 97, 83, 92, 98, 92],
                ["Novruzlu Kadir", "5A", 3, 82, 100, 90, 87, 51, 96, 94, 94, 83, 50, 89, 82, 84],
                ["Rəsulov Camal", "5A", 6, 70, 73, 77, 80, 66, 86, 90, 90, 80, 63, 74, 82, 90],
                ["Sadmaliyeva Sara", "5A", 2, 73, 93, 53, 88, 93, 83, 84, 85, 73, 67, 84, 79, 91],
                ["Salmanov Ömər", "5A", 5, 80, 93, 93, 80, 73, 88, 92, 92, 90, 87, 93, 87, 83],
                ["Zəbiyeva Nilufər", "5A", 4, 77, 93, 92, 69, 49, 87, 85, 85, 83, 67, 79, 72, 83],
                ["Ağayev Ömər", "5B", 6, 48, 40, 18, 71, 74, 46, 79, 82, 43, 37, 51, 58, 96],
                ["Əhmədli Rəşid", "5B", 3, 94, 93, 97, 46, 48, 86, 94, 95, 97, 67, 64, 92, 97],
                ["Əhmədov Nazim", "5B", 7, 82, 80, 84, 66, 65, 95, 91, 92, 90, 70, 92, 72, 98],
                ["Əlizadə Amal", "5B", 12, 34, 33, 27, 46, 84, 63, 84, 84, 60, 33, 66, 60, 97],
                ["Hüseynli Şəbnəm", "5B", 9, 41, 53, 23, 22, 30, 67, 76, 82, 33, 13, 56, 70, 86],
                ["Hüseynli Zeynəb", "5B", 4, 82, 67, 74, 87, 69, 93, 84, 84, 77, 63, 63, 80, 98],
                ["Işılak Esmanur", "5B", 10, 64, 60, 31, 52, 43, 75, 90, 87, 77, 33, 71, 63, 88],
                ["İsgəndərli İlayda", "5B", 4, 83, 100, 85, 82, 64, 93, 85, 85, 97, 60, 93, 73, 91],
                ["İsmayılov Məhyəddin", "5B", 3, 76, 100, 77, 84, 68, 100, 84, 90, 93, 90, 80, 87, 96],
                ["Məmmədli Aida", "5B", 2, 72, 93, 73, 90, 95, 94, 88, 89, 93, 63, 83, 75, 94],
                ["Məmmədova Məryəm", "5B", 5, 67, 80, 73, 94, 86, 91, 90, 89, 87, 93, 91, 72, 92],
                ["Məmmədzadə Aminə", "5B", 3, 75, 93, 77, 82, 73, 92, 91, 92, 97, 70, 93, 95, 90],
                ["Namazlı Zəhra", "5B", 18, 34, 20, 36, 19, 32, 54, 72, 75, 43, 37, 57, 60, 87],
                ["Osmanlı İnci", "5B", 0, 77, 93, 84, 86, 90, 86, 85, 84, 90, 67, 79, 73, 92],
                ["Paşa Mahmud", "5B", 7, 91, 93, 88, 71, 61, 93, 94, 94, 93, 87, 86, 87, 90],
                ["Rayi Məryəm Nilufər", "5B", 3, 36, 60, 18, 25, 43, 75, 82, 86, 30, 30, 74, 70, 86],
                ["Surxayzadə Xədicə", "5B", 9, 73, 73, 49, 35, 35, 91, 79, 85, 87, 67, 83, 82, 93],
                ["Yunus İnci", "5B", 0, 65, 47, 40, 81, 94, 75, 87, 88, 73, 33, 93, 73, 94]
            ],
            // 6. sınıf
            '6': [
                ["Şagird", "Sinif", "Davamsızlıq sayı", "Azərbaycan dili", "Ədəbiyyat", "Riyaziyyat", "İngilis dili", "Rus dili", "Türk dili", "İnformatika", "Texnologiya", "Təbiət", "Azərbaycan Tarixi", "Tarix", "Coğrafiya", "Musiqi", "Təsviri İncəsənət", "Fiziki tərbiyə"],
                ["Calalova Məryəm", "6A", 6, 58, 67, 39, 42, 54, 58, 89, 86, 50, 47, 47, 43, 80, 60, 89],
                ["Cəfərzadə Atilla", "6A", 8, 79, 100, 63, 75, 65, 83, 88, 87, 90, 63, 87, 80, 90, 65, 87],
                ["Əhmədli Məryəm", "6A", 1, 72, 87, 38, 97, 68, 88, 82, 86, 73, 43, 53, 63, 83, 98, 93],
                ["Əlizadə Aylin", "6A", 9, 71, 73, 28, 75, 97, 85, 90, 89, 57, 50, 73, 67, 91, 72, 93],
                ["İmamzadə Fatimə", "6A", 0, 63, 93, 31, 51, 46, 87, 88, 87, 67, 43, 60, 80, 81, 80, 93],
                ["İsmayıllı Xalid", "6A", 5, 53, 73, 25, 46, 31, 63, 78, 83, 43, 47, 33, 63, 67, 59, 89],
                ["Kazımlı Ceyla", "6A", 1, 90, 93, 92, 69, 63, 86, 86, 87, 87, 73, 87, 90, 82, 73, 88],
                ["Qənbərli Turqut", "6A", 4, 81, 93, 75, 93, 66, 88, 97, 95, 97, 70, 100, 83, 88, 78, 88],
                ["Manaflı Murad", "6A", 5, 86, 100, 54, 78, 65, 86, 89, 87, 80, 60, 67, 90, 80, 57, 92],
                ["Məmmədli Fərhad", "6A", 3, 78, 60, 54, 71, 82, 64, 87, 88, 60, 33, 73, 43, 73, 57, 83],
                ["Məmmədli Hüseyn", "6A", 3, 50, 73, 28, 67, 39, 75, 89, 85, 50, 53, 40, 77, 77, 57, 92],
                ["Muradova Selcan", "6A", 1, 89, 93, 69, 99, 69, 90, 93, 90, 90, 70, 73, 80, 83, 93, 88],
                ["Nağıyev Səyyad", "6A", 2, 73, 87, 78, 84, 58, 78, 94, 94, 93, 77, 93, 87, 75, 78, 86],
                ["Osmanova Məryəm", "6A", 3, 94, 100, 88, 89, 62, 93, 95, 95, 93, 80, 100, 93, 92, 85, 89],
                ["Sərdarlı Xədicə", "6A", 9, 27, 0, 13, 18, 31, 60, 75, 81, 27, 30, 27, 20, 57, 60, 85],
                ["Sultanov Fateh", "6A", 4, 58, 33, 50, 48, 97, 70, 84, 86, 70, 37, 13, 77, 83, 58, 91],
                ["Təhməzli Mete", "6A", 0, 65, 87, 59, 48, 48, 80, 90, 90, 50, 50, 67, 70, 77, 75, 92],
                ["Vəliyeva Zəhra", "6A", 5, 67, 87, 54, 68, 43, 79, 78, 84, 37, 37, 60, 63, 81, 85, 87],
                ["Alqayeva Kamilə", "6A", 2, 77, 73, 71, 66, 58, 85, 84, 83, 83, 47, 73, 67, 83, 92, 91],
                ["Eyvazova Məryəm", "6A", 2, 88, 93, 54, 79, 95, 74, 79, 84, 67, 50, 40, 67, 93, 87, 95],
                ["Əhmədov Azər", "6B", 12, 15, 33, 17, 10, 27, 69, 55, 57, 30, 23, 47, 30, 50, 52, 55],
                ["Əlirzayev Həsən", "6B", 4, 74, 87, 55, 71, 81, 84, 94, 94, 80, 60, 53, 67, 87, 90, 82],
                ["Əsgərova Aylin", "6B", 0, 99, 100, 97, 86, 81, 94, 85, 85, 93, 70, 100, 83, 95, 95, 97],
                ["Həşimli Zeynəb", "6B", 7, 67, 87, 44, 54, 57, 79, 89, 90, 73, 60, 33, 57, 87, 75, 83],
                ["Hüseynli Mustafa", "6B", 3, 85, 100, 72, 80, 74, 85, 93, 93, 100, 83, 80, 97, 97, 97, 88],
                ["Hüseynli Zəhra", "6B", 0, 96, 100, 93, 95, 84, 93, 92, 91, 97, 97, 100, 100, 100, 100, 93],
                ["İsmayıl Ayxan", "6B", 3, 64, 100, 59, 82, 75, 69, 90, 90, 90, 67, 53, 77, 69, 83, 76],
                ["İsmayılzadə Mikayıl", "6B", 6, 46, 47, 61, 85, 84, 62, 86, 88, 73, 37, 13, 47, 75, 67, 77],
                ["Mahmudlu Altay", "6B", 2, 95, 100, 96, 94, 77, 90, 96, 96, 100, 97, 100, 93, 80, 95, 82],
                ["Mahmudova Zümrüd", "6B", 0, 96, 100, 93, 99, 82, 95, 94, 95, 97, 90, 87, 97, 100, 93, 90],
                ["Məmmədli Ağa", "6B", 5, 29, 47, 23, 19, 27, 57, 78, 83, 43, 37, 27, 33, 55, 65, 70],
                ["Məmmədova Ləman", "6B", 2, 99, 100, 97, 94, 95, 97, 97, 96, 97, 90, 100, 97, 100, 93, 92],
                ["Mustafa Muhammed", "6B", 17, 60, 73, 37, 35, 35, 82, 78, 86, 53, 40, 33, 53, 75, 77, 83],
                ["Namazlı Banu", "6B", 11, 78, 100, 42, 72, 63, 91, 88, 87, 73, 67, 80, 73, 85, 87, 83],
                ["Paşazadə Xədicə", "6B", 4, 50, 93, 47, 49, 51, 76, 86, 86, 70, 43, 33, 70, 83, 98, 90],
                ["Şahmərdanov Ramal", "6B", 1, 66, 93, 35, 41, 62, 78, 90, 89, 63, 47, 67, 73, 80, 67, 83]
            ],
            // 7-8. sınıflar
            '7-8': [
                ["Şagird", "Sinif", "Davamsızlıq sayı", "Azərbaycan dili", "Ədəbiyyat", "Riyaziyyat", "İngilis dili", "Rus dili", "Türk dili", "İnformatika", "Texnologiya", "Biologiya", "Fizika", "Kimya", "Azərbaycan Tarixi", "Tarix", "Coğrafiya", "Musiqi", "Təsviri İncəsənət", "Fiziki tərbiyə"],
                ["Ağayeva Əzizə", "7A", 7, 46, 60, 50, 90, 68, 80, 79, 83, 30, 47, 60, 43, 33, 50, 83, 87, 83],
                ["Əliyev Yusif", "7A", 8, 87, 93, 88, 94, 83, 98, 91, 91, 60, 93, 93, 63, 93, 93, 87, 88, 93],
                ["Göyüşlü Aişə", "7A", 6, 63, 67, 49, 87, 61, 85, 78, 82, 40, 53, 80, 40, 47, 40, 82, 80, 82],
                ["Hüseynli Əminə", "7A", 11, 52, 27, 15, 26, 35, 80, 75, 83, 27, 33, 50, 33, 27, 37, 78, 67, 79],
                ["İbrahimov Ömər", "7A", 12, 64, 53, 73, 84, 39, 85, 89, 89, 43, 63, 47, 63, 40, 77, 67, 92, 83],
                ["Karahan Taha", "7A", 1, 36, 40, 30, 56, 41, 91, 78, 84, 37, 40, 37, 27, 60, 50, 77, 72, 84],
                ["Qədməliyev Murad", "7A", 17, 48, 47, 42, 31, 35, 81, 82, 86, 43, 67, 67, 40, 53, 67, 72, 72, 82],
                ["Qəhrəmanova Qəmər", "7A", 3, 31, 33, 28, 46, 93, 75, 84, 85, 33, 33, 30, 27, 27, 50, 79, 68, 82],
                ["Quliyev Asim", "7A", 7, 84, 93, 84, 87, 84, 96, 91, 91, 67, 73, 93, 70, 53, 90, 82, 87, 92],
                ["Quliyev Ömər", "7A", 3, 80, 80, 75, 91, 62, 98, 94, 95, 60, 73, 97, 60, 67, 87, 81, 87, 91],
                ["Quluzadə Əhməd", "7A", 9, 43, 53, 39, 45, 47, 78, 84, 85, 33, 53, 60, 27, 33, 67, 63, 73, 88],
                ["Məmmədzadə Mustafa", "7A", 5, 61, 60, 58, 76, 36, 84, 87, 87, 30, 50, 60, 33, 33, 40, 63, 82, 87],
                ["Namazlı Zeynəb", "7A", 10, 76, 53, 54, 89, 53, 100, 85, 86, 47, 63, 80, 37, 27, 67, 78, 75, 89],
                ["Paşazadə Mədinə", "7A", 4, 80, 73, 78, 75, 63, 94, 84, 88, 67, 83, 97, 80, 80, 100, 87, 100, 89],
                ["Rəfiyeva Zəhra", "7A", 3, 32, 40, 26, 34, 37, 73, 86, 86, 43, 30, 47, 20, 13, 43, 72, 72, 84],
                ["Abdullayev İskəndər", "7B", 3, 76, 67, 72, 87, 62, 84, 94, 93, 57, 87, 87, 80, 80, 77, 92, 82, 84],
                ["Cenikoğlu Kaan", "7B", 5, 56, 40, 40, 42, 40, 94, 86, 86, 33, 43, 60, 53, 47, 60, 31, 70, 87],
                ["Eyvazova Zəhra", "7B", 3, 83, 73, 68, 93, 88, 83, 89, 87, 63, 60, 90, 63, 100, 80, 93, 82, 94],
                ["Əsədullazadə Nur", "7B", 0, 89, 67, 74, 97, 82, 90, 92, 90, 57, 67, 87, 87, 80, 87, 74, 88, 94],
                ["Həşimli Şəms", "7B", 4, 77, 67, 81, 84, 86, 86, 88, 88, 53, 67, 93, 47, 53, 83, 62, 82, 88],
                ["Quluzadə İlkin", "7B", 4, 86, 67, 59, 81, 74, 88, 91, 89, 77, 80, 87, 70, 100, 97, 80, 83, 91],
                ["Mehdizadə Ramin", "7B", 8, 54, 53, 56, 55, 65, 95, 89, 89, 47, 53, 60, 50, 73, 63, 73, 85, 91],
                ["Nəsibli Mehriban", "7B", 2, 78, 53, 62, 57, 34, 79, 81, 82, 43, 67, 90, 33, 40, 73, 68, 73, 89],
                ["Nəsibov Elcan", "7B", 16, 29, 27, 23, 33, 37, 58, 85, 85, 37, 47, 43, 27, 47, 43, 34, 62, 84],
                ["Novruzov Rövşən", "7B", 1, 84, 67, 55, 73, 49, 89, 86, 86, 40, 63, 87, 67, 60, 73, 62, 60, 89],
                ["Təhməzli Xəlil", "7B", 0, 72, 60, 80, 57, 39, 85, 90, 90, 80, 83, 93, 83, 87, 87, 86, 80, 90],
                ["Vəlizadə Ayxan", "7B", 1, 44, 47, 21, 44, 32, 75, 94, 94, 43, 33, 23, 43, 20, 67, 55, 83, 87],
                ["Zalov Levent", "7B", 2, 56, 53, 44, 65, 48, 77, 88, 88, 37, 23, 33, 33, 40, 63, 76, 80, 90],
                ["Calalova Zeynəb", "8A", 5, 59, 60, 64, 49, 35, 85, 89, 89, 43, 47, 53, 27, 53, 50, 90, 55, 89],
                ["Hüseynli Fatimə", "8A", 0, 48, 40, 68, 38, 47, 86, 90, 89, 50, 50, 47, 23, 40, 23, 89, 60, 89],
                ["Kərimli Fərhad", "8A", 2, 62, 20, 55, 52, 78, 95, 85, 84, 47, 60, 63, 40, 67, 60, 91, 67, 86],
                ["Quluzadə Nəzrin", "8A", 4, 59, 47, 50, 80, 84, 90, 93, 91, 33, 50, 60, 23, 33, 53, 91, 82, 83],
                ["Manaflı Mürsəl", "8A", 7, 65, 53, 61, 55, 53, 90, 87, 87, 30, 47, 83, 53, 67, 57, 97, 50, 87],
                ["Məmmədov Tuncay", "8A", 13, 54, 40, 18, 38, 31, 83, 81, 84, 47, 13, 33, 40, 40, 20, 74, 47, 87],
                ["Məmmədzadə Nuriyyə", "8A", 7, 86, 87, 89, 68, 61, 95, 90, 90, 87, 90, 83, 93, 93, 87, 98, 85, 91],
                ["Nəsibli Cavanşir", "8A", 2, 65, 47, 48, 54, 42, 82, 92, 92, 70, 73, 73, 57, 73, 70, 71, 77, 90],
                ["Nəzirli Uğur", "8A", 2, 64, 77, 66, 58, 80, 83, 81, 82, 57, 57, 68, 79, 93, 72, 97, 87, 93],
                ["Novruzlu Elcan", "8A", 6, 62, 53, 73, 44, 48, 88, 78, 85, 40, 53, 50, 53, 47, 57, 85, 40, 87],
                ["Cahangirov Gündüz", "8B", 4, 64, 60, 45, 42, 31, 83, 86, 86, 50, 60, 73, 93, 93, 90, 71, 53, 81],
                ["Əkbərli Ömər", "8B", 4, 66, 73, 42, 53, 45, 79, 84, 84, 30, 43, 37, 43, 60, 57, 66, 38, 92],
                ["Əlizadə Cavad", "8B", 2, 76, 73, 64, 62, 84, 71, 82, 87, 40, 77, 43, 80, 73, 90, 84, 37, 89],
                ["Hacıyev Cavanşir", "8B", 2, 66, 47, 40, 55, 49, 80, 86, 88, 43, 67, 77, 63, 73, 87, 62, 35, 91],
                ["Həsənova Nurgül", "8B", 7, 29, 73, 32, 94, 89, 98, 65, 63, 87, 90, 90, 73, 67, 83, 67, 67, 55],
                ["Hüseynli Leyla", "8B", 11, 69, 53, 54, 33, 36, 93, 85, 84, 40, 47, 57, 33, 27, 40, 75, 68, 89],
                ["İsmayılzadə Sədi", "8B", 4, 69, 27, 77, 78, 92, 81, 97, 95, 27, 70, 57, 67, 47, 67, 76, 50, 93],
                ["Quluzadə Safiyyə", "8B", 6, 88, 100, 100, 90, 82, 96, 95, 93, 87, 97, 100, 93, 100, 100, 90, 90, 90],
                ["Məlikova Aylin", "8B", 7, 74, 87, 76, 74, 76, 89, 96, 95, 63, 90, 70, 70, 73, 90, 80, 83, 85],
                ["Musayeva Fidan", "8B", 3, 72, 53, 56, 59, 58, 97, 87, 87, 30, 33, 63, 33, 33, 53, 84, 72, 93],
                ["Sultanova Fatimə", "8B", 5, 46, 27, 53, 46, 98, 77, 80, 85, 37, 37, 57, 23, 27, 60, 81, 45, 89],
                ["Şərifova Şərqiyyə", "8B", 0, 76, 60, 55, 78, 41, 96, 86, 86, 33, 47, 60, 53, 67, 70, 83, 68, 89]
            ],
            // 9. sınıf
            '9': [
                ["Şagird", "Sinif", "Davamsızlıq sayı", "Azərbaycan dili", "Riyaziyyat", "İngilis dili"],
                ["Abbaslı Ruqəyya", "9A", 0, 54, 69, 81],
                ["Əhmədli Gülbahar", "9A", 2, 66, 67, 96],
                ["Əlizadə Pakizə", "9A", 0, 82, 79, 91],
                ["Əmirov Amin", "9A", 5, 83, 93, 81],
                ["Hüseynli Dəniz", "9A", 2, 77, 72, 90],
                ["İbrahimov Ayaz", "9A", 4, 69, 69, 86],
                ["Mahmudov Xalid", "9A", 2, 82, 84, 93],
                ["Məmmədzadə Kürsüm", "9A", 5, 69, 82, 86],
                ["Mütəllimli Selcan", "9A", 0, 84, 70, 83],
                ["Zalova Süheyla", "9A", 3, 71, 57, 90],
                ["Zeynalov İbrahim", "9A", 4, 73, 43, 91],
                ["Əsgərova Ləman", "9B", 4, 65, 62, 79],
                ["Məmmədxanlı Aslan", "9B", 10, 47, 17, 34],
                ["Məmmədova Nuray", "9B", 3, 62, 50, 83],
                ["Murad Renat", "9B", 3, 47, 63, 90],
                ["Novruzlu Nübar", "9B", 4, 69, 26, 59],
                ["Vəlizadə İnci", "9B", 4, 62, 41, 87]
            ]
        };

        // =============================================
        // GLOBAL DEĞİŞKENLER
        // =============================================
        let schoolData = {
            students: [],
            subjects: [],
            classes: [],
            overallStats: {}
        };

        let charts = {};

        // =============================================
        // SAYFA YÜKLENDİĞİNDE ÇALIŞACAK KOD
        // =============================================
        document.addEventListener('DOMContentLoaded', function () {
            // Tarihi göster
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('az-AZ', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Gömülü verileri yükle
            loadEmbeddedData();

            // Navigation event listener'larını ayarla
            document.querySelectorAll('.nav-link, .mobile-nav-btn').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Update active link
                    document.querySelectorAll('.nav-link, .mobile-nav-btn').forEach(l => {
                        l.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Show selected section
                    const section = this.getAttribute('data-section');
                    document.querySelectorAll('.content-section').forEach(sec => {
                        sec.style.display = 'none';
                    });

                    document.getElementById(`${section}-section`).style.display = 'block';

                    // Mobil cihazlarda yumuşak kaydırma
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            window.scrollTo({
                                top: 120,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                });
            });

            // Sistem bilgisini güncelle
            document.getElementById('data-info').textContent = 'Gömülü verilər (2-9. siniflər)';
            document.getElementById('last-update').textContent = `Son yeniləmə: ${new Date().toLocaleTimeString('az-AZ')}`;

            // Mobil nav pozisyonunu ayarla
            adjustMobileNavPosition();
            window.addEventListener('resize', adjustMobileNavPosition);
        });

        // Mobil nav pozisyonunu ayarla
        function adjustMobileNavPosition() {
            if (window.innerWidth <= 768) {
                const navbarHeight = document.querySelector('.navbar').offsetHeight;
                document.getElementById('mobile-nav').style.top = `${navbarHeight}px`;
            }
        }

        // =============================================
        // GÖMÜLÜ VERİLERİ YÜKLE
        // =============================================
        function loadEmbeddedData() {
            console.log('📊 Gömülü veriler yükleniyor...');

            // Tüm sheet'leri işle
            for (const [sheetName, sheetData] of Object.entries(embeddedExcelData)) {
                processSheetData(sheetData, sheetName);
            }

            // Verileri analiz et
            analyzeData();

            console.log('✅ Veriler başarıyla yüklendi!');
            console.log(`   Toplam öğrenci: ${schoolData.students.length}`);
            console.log(`   Sınıflar: ${schoolData.classes.join(', ')}`);
            console.log(`   Dersler: ${schoolData.subjects.length} adet`);
        }

        // =============================================
        // EXCEL SHEET VERİLERİNİ İŞLE
        // =============================================
        function processSheetData(sheetData, sheetName) {
            if (!sheetData || sheetData.length < 2) return;

            const headers = sheetData[0];
            const rows = sheetData.slice(1);

            rows.forEach((row, index) => {
                if (row.length < 3) return;

                const student = {
                    id: schoolData.students.length + 1,
                    name: row[0] || '',
                    className: row[1] || '',
                    attendance: parseInt(row[2]) || 0,
                    gradeLevel: getGradeLevel(row[1]),
                    sheetName: sheetName,
                    subjects: {}
                };

                // Ders notlarını parse et
                for (let i = 3; i < headers.length; i++) {
                    if (i < row.length) {
                        const subject = headers[i];
                        const grade = parseFloat(row[i]) || 0;
                        student.subjects[subject] = grade;
                    }
                }

                // Öğrenci ortalamasını hesapla
                const grades = Object.values(student.subjects).filter(g => !isNaN(g));
                student.average = grades.length > 0 ?
                    grades.reduce((a, b) => a + b, 0) / grades.length : 0;

                // En iyi ve en kötü dersleri bul
                const subjectEntries = Object.entries(student.subjects);
                if (subjectEntries.length > 0) {
                    subjectEntries.sort((a, b) => b[1] - a[1]);
                    student.bestSubject = subjectEntries[0][0];
                    student.bestGrade = subjectEntries[0][1];
                    student.worstSubject = subjectEntries[subjectEntries.length - 1][0];
                    student.worstGrade = subjectEntries[subjectEntries.length - 1][1];
                }

                // Durumu belirle
                if (student.average >= 85) student.status = 'Əla';
                else if (student.average >= 70) student.status = 'Yaxşı';
                else if (student.average >= 50) student.status = 'Kafi';
                else student.status = 'Zəif';

                // Davamsızlık durumunu belirle
                if (student.attendance === 0) student.attendanceStatus = 'Mükəmməl';
                else if (student.attendance <= 4) student.attendanceStatus = 'Yaxşı';
                else if (student.attendance <= 9) student.attendanceStatus = 'Orta';
                else if (student.attendance <= 14) student.attendanceStatus = 'Yüksək';
                else student.attendanceStatus = 'Təhlükəli';

                schoolData.students.push(student);
            });
        }

        // =============================================
        // SINIF SEVİYESİNİ BELİRLE
        // =============================================
        function getGradeLevel(className) {
            if (!className) return '';
            const match = className.match(/(\d+)/);
            if (match) {
                return parseInt(match[1]);
            }
            return '';
        }

        // =============================================
        // VERİLERİ ANALİZ ET
        // =============================================
        function analyzeData() {
            // Benzersiz sınıfları çıkar
            const classSet = new Set();
            schoolData.students.forEach(s => classSet.add(s.className));
            schoolData.classes = Array.from(classSet).sort();

            // Tüm dersleri topla
            const allSubjects = new Set();
            schoolData.students.forEach(student => {
                Object.keys(student.subjects).forEach(subject => {
                    allSubjects.add(subject);
                });
            });
            schoolData.subjects = Array.from(allSubjects).sort();

            // Genel istatistikleri hesapla
            calculateOverallStats();

            // Tüm görünümleri güncelle
            updateDashboard();
            updateStudentsView();
            updateAttendanceView();
            updateSubjectsView();
            updateClassesView();
            updateComparisonView();
            updateFilters();
        }

        // =============================================
        // GENEL İSTATİSTİKLERİ HESAPLA
        // =============================================
        function calculateOverallStats() {
            const stats = {
                totalStudents: schoolData.students.length,
                totalClasses: schoolData.classes.length,
                totalSubjects: schoolData.subjects.length,
                overallAverage: 0,
                averageAttendance: 0,
                classAverages: {},
                subjectAverages: {},
                gradeAverages: {},
                attendanceStats: {
                    excellent: 0,
                    good: 0,
                    medium: 0,
                    high: 0,
                    dangerous: 0
                },
                warningStudents: 0
            };

            // Genel ortalama
            const allAverages = schoolData.students.map(s => s.average).filter(a => !isNaN(a));
            stats.overallAverage = allAverages.length > 0 ?
                allAverages.reduce((a, b) => a + b, 0) / allAverages.length : 0;

            // Davamsızlık istatistikleri
            const allAttendance = schoolData.students.map(s => s.attendance).filter(a => !isNaN(a));
            stats.averageAttendance = allAttendance.length > 0 ?
                allAttendance.reduce((a, b) => a + b, 0) / allAttendance.length : 0;

            // Davamsızlık kategorileri
            schoolData.students.forEach(student => {
                if (student.attendance === 0) stats.attendanceStats.excellent++;
                else if (student.attendance <= 4) stats.attendanceStats.good++;
                else if (student.attendance <= 9) stats.attendanceStats.medium++;
                else if (student.attendance <= 14) stats.attendanceStats.high++;
                else stats.attendanceStats.dangerous++;
            });

            // Diqqət lazım olan şagirdlər
            stats.warningStudents = schoolData.students.filter(s => 
                s.average < 50 || s.attendance >= 10
            ).length;

            // Sınıf ortalamaları
            schoolData.classes.forEach(className => {
                const classStudents = schoolData.students.filter(s => s.className === className);
                const classAverages = classStudents.map(s => s.average).filter(a => !isNaN(a));
                const classAttendance = classStudents.map(s => s.attendance).filter(a => !isNaN(a));
                
                stats.classAverages[className] = {
                    average: classAverages.length > 0 ?
                        classAverages.reduce((a, b) => a + b, 0) / classAverages.length : 0,
                    attendance: classAttendance.length > 0 ?
                        classAttendance.reduce((a, b) => a + b, 0) / classAttendance.length : 0,
                    studentCount: classStudents.length
                };
            });

            // Ders ortalamaları
            schoolData.subjects.forEach(subject => {
                const allGrades = schoolData.students.map(s => s.subjects[subject]).filter(g => !isNaN(g));
                stats.subjectAverages[subject] = allGrades.length > 0 ?
                    allGrades.reduce((a, b) => a + b, 0) / allGrades.length : 0;
                
                // Sınıf seviyesine göre ders ortalamaları
                stats.subjectAverages[subject + '_byGrade'] = {};
                for (let grade = 2; grade <= 9; grade++) {
                    const gradeStudents = schoolData.students.filter(s => s.gradeLevel === grade);
                    const gradeGrades = gradeStudents.map(s => s.subjects[subject]).filter(g => !isNaN(g));
                    if (gradeGrades.length > 0) {
                        stats.subjectAverages[subject + '_byGrade'][grade] = 
                            gradeGrades.reduce((a, b) => a + b, 0) / gradeGrades.length;
                    }
                }
            });

            // Sınıf seviyesi ortalamaları
            for (let grade = 2; grade <= 9; grade++) {
                const gradeStudents = schoolData.students.filter(s => s.gradeLevel === grade);
                const gradeAverages = gradeStudents.map(s => s.average).filter(a => !isNaN(a));
                if (gradeAverages.length > 0) {
                    stats.gradeAverages[grade] = gradeAverages.reduce((a, b) => a + b, 0) / gradeAverages.length;
                }
            }

            schoolData.overallStats = stats;
            
            // Quick stats'i güncelle
            document.getElementById('quick-total-students').textContent = stats.totalStudents;
            document.getElementById('quick-total-classes').textContent = stats.totalClasses;
        }

        // =============================================
        // DASHBOARD'U GÜNCELLE
        // =============================================
        function updateDashboard() {
            const stats = schoolData.overallStats;

            // İstatistik kartlarını güncelle
            document.getElementById('total-students').textContent = stats.totalStudents;
            document.getElementById('total-classes-info').textContent = `${stats.totalClasses} sinif`;
            document.getElementById('overall-average').textContent = stats.overallAverage.toFixed(1);
            document.getElementById('avg-attendance').textContent = stats.averageAttendance.toFixed(1);
            document.getElementById('warning-students').textContent = stats.warningStudents;

            // Trend bilgileri
            const avgAttendance = stats.averageAttendance;
            let attendanceStatus = 'Yaxşı';
            if (avgAttendance <= 3) attendanceStatus = 'Mükəmməl';
            else if (avgAttendance <= 6) attendanceStatus = 'Yaxşı';
            else if (avgAttendance <= 10) attendanceStatus = 'Orta';
            else attendanceStatus = 'Narahatlıq doğurur';

            document.getElementById('attendance-status').textContent = attendanceStatus;
            document.getElementById('warning-info').textContent = `${stats.warningStudents} şagird nəzərə alınmalıdır`;

            // Grafikleri güncelle
            updateSubjectAvgChart();
            updateAttendanceChart();

            // Listeleri güncelle
            updateTopStudentsList();
            updateWarningStudentsList();
        }

        // =============================================
        // DERS ORTALAMALARI GRAFİĞİ
        // =============================================
        function updateSubjectAvgChart() {
            const ctx = document.getElementById('subjectAvgChart').getContext('2d');
            const stats = schoolData.overallStats;

            const subjects = schoolData.subjects;
            const averages = subjects.map(subject => stats.subjectAverages[subject]);

            const sortedIndices = averages.map((_, i) => i)
                .sort((a, b) => averages[b] - averages[a])
                .slice(0, 8);

            const sortedSubjects = sortedIndices.map(i => subjects[i]);
            const sortedAverages = sortedIndices.map(i => averages[i]);

            if (charts.subjectAvgChart) {
                charts.subjectAvgChart.destroy();
            }

            charts.subjectAvgChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSubjects,
                    datasets: [{
                        label: 'Ortalama',
                        data: sortedAverages,
                        backgroundColor: sortedAverages.map(avg => {
                            if (avg >= 80) return 'rgba(16, 185, 129, 0.7)';
                            if (avg >= 60) return 'rgba(0, 173, 186, 0.7)';
                            if (avg >= 50) return 'rgba(245, 158, 11, 0.7)';
                            return 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderColor: sortedAverages.map(avg => {
                            if (avg >= 80) return 'rgb(16, 185, 129)';
                            if (avg >= 60) return 'rgb(0, 173, 186)';
                            if (avg >= 50) return 'rgb(245, 158, 11)';
                            return 'rgb(239, 68, 68)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Ortalama: ${context.raw.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Ortalama'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fənlər'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // DAVAMSIZLIK GRAFİĞİ
        // =============================================
        function updateAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const stats = schoolData.overallStats.attendanceStats;

            const data = {
                excellent: stats.excellent,
                good: stats.good,
                medium: stats.medium,
                high: stats.high,
                dangerous: stats.dangerous
            };

            if (charts.attendanceChart) {
                charts.attendanceChart.destroy();
            }

            charts.attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mükəmməl (0 gün)', 'Yaxşı (1-4 gün)', 'Orta (5-9 gün)', 'Yüksək (10-14 gün)', 'Təhlükəli (15+ gün)'],
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            'rgba(79, 209, 197, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(79, 209, 197)',
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} şagird (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // EN İYİ ÖĞRENCİLER LİSTESİ
        // =============================================
        function updateTopStudentsList() {
            const topStudents = [...schoolData.students]
                .sort((a, b) => b.average - a.average)
                .slice(0, 5);

            const container = document.getElementById('top-students-list');
            container.innerHTML = '';

            if (topStudents.length === 0) {
                container.innerHTML = '<p class="text-muted">Məlumat yoxdur</p>';
                return;
            }

            topStudents.forEach((student, index) => {
                const medal = ['🥇', '🥈', '🥉', '4.', '5.'][index];
                const studentEl = document.createElement('div');
                studentEl.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                studentEl.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="fs-5 me-2">${medal}</span>
                        <div>
                            <strong>${student.name}</strong><br>
                            <small class="text-muted">${student.className} | Ortalama: ${student.average.toFixed(1)} | Davamsızlıq: ${student.attendance} gün</small>
                        </div>
                    </div>
                    <span class="badge ${getStatusBadgeClass(student.status)}">${student.status}</span>
                `;
                container.appendChild(studentEl);
            });
        }

        // =============================================
        // DİQQƏT LAZIM OLANLAR LİSTESİ
        // =============================================
        function updateWarningStudentsList() {
            const warningStudents = [...schoolData.students]
                .filter(s => s.average < 50 || s.attendance >= 10)
                .sort((a, b) => {
                    if (a.average < 50 && b.average < 50) {
                        return a.average - b.average;
                    }
                    if (a.attendance >= 10 && b.attendance >= 10) {
                        return b.attendance - a.attendance;
                    }
                    return (a.average < 50 ? 0 : 1) - (b.average < 50 ? 0 : 1);
                })
                .slice(0, 5);

            const container = document.getElementById('warning-students-list');
            container.innerHTML = '';

            if (warningStudents.length === 0) {
                container.innerHTML = '<div class="text-center p-3"><i class="fas fa-check-circle fa-2x text-success mb-2"></i><p>Təbriklər! Diqqət lazım olan şagird yoxdur.</p></div>';
                return;
            }

            warningStudents.forEach((student, index) => {
                const reason = student.average < 50 ? 'Aşağı ortalama' : 'Yüksək davamsızlıq';
                const studentEl = document.createElement('div');
                studentEl.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                studentEl.innerHTML = `
                    <div>
                        <strong>${student.name}</strong><br>
                        <small class="text-muted">${student.className} | ${reason}</small>
                    </div>
                    <div class="text-end">
                        <div class="badge ${student.average < 50 ? 'bg-danger' : 'bg-warning'}">
                            ${student.average < 50 ? student.average.toFixed(1) : student.attendance + ' gün'}
                        </div>
                        <div><small>${student.average < 50 ? 'Ortalama' : 'Davamsızlıq'}</small></div>
                    </div>
                `;
                container.appendChild(studentEl);
            });
        }

        // =============================================
        // FİLTRELERİ GÜNCELLE
        // =============================================
        function updateFilters() {
            // Sınıf filtrelerini güncelle
            const classFilters = [
                'student-class-filter',
                'attendance-class-filter',
                'subject-class-filter'
            ];

            classFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                select.innerHTML = '<option value="all">Hamısı</option>';
                
                // Sınıfları grupla
                const classGroups = {};
                schoolData.classes.forEach(className => {
                    const gradeLevel = getGradeLevel(className);
                    if (!classGroups[gradeLevel]) {
                        classGroups[gradeLevel] = [];
                    }
                    classGroups[gradeLevel].push(className);
                });

                // Her sınıf seviyesi için optgroup oluştur
                Object.keys(classGroups).sort().forEach(gradeLevel => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${gradeLevel}-ci sinif`;
                    
                    classGroups[gradeLevel].sort().forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                });
            });
        }

        // =============================================
        // ÖĞRENCİ GÖRÜNÜMÜNÜ GÜNCELLE
        // =============================================
        function updateStudentsView() {
            const tableBody = document.getElementById('students-table-body');
            tableBody.innerHTML = '';

            const classFilter = document.getElementById('student-class-filter').value;
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            const sortBy = document.getElementById('student-sort').value;

            let filteredStudents = schoolData.students;

            // Filtreleri uygula
            if (classFilter !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.className === classFilter);
            }

            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s =>
                    s.name.toLowerCase().includes(searchTerm)
                );
            }

            // Sıralamayı uygula
            if (sortBy === 'name') {
                filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'average_desc') {
                filteredStudents.sort((a, b) => b.average - a.average);
            } else if (sortBy === 'average_asc') {
                filteredStudents.sort((a, b) => a.average - b.average);
            } else if (sortBy === 'attendance_desc') {
                filteredStudents.sort((a, b) => b.attendance - a.attendance);
            } else if (sortBy === 'attendance_asc') {
                filteredStudents.sort((a, b) => a.attendance - b.attendance);
            }

            // Sayacı güncelle
            document.getElementById('student-count').textContent = `${filteredStudents.length} şagird`;

            // Tabloyu doldur
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-photo">
                                <img src="https://i.imgur.com/a3FuVV8.png" 
                                     alt="IMSA Logo"
                                     onerror="this.onerror=null; this.src='https://placehold.co/36x36/00525d/ffffff?text=IMSA';">
                            </div>
                            <div class="ms-2">
                                <strong>${student.name}</strong><br>
                                <small class="text-muted">${student.bestSubject || '-'}: ${student.bestGrade || 0}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${student.className}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <strong>${student.average.toFixed(1)}</strong>
                            <div class="progress progress-custom ms-2" style="width: 50px;">
                                <div class="progress-bar ${getProgressBarClass(student.average)}" 
                                     style="width: ${student.average}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="attendance-badge ${getAttendanceClass(student.attendance)}">
                            ${student.attendance} gün
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(student.status)}">
                            ${student.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewStudentDetails(${student.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Filtre event listener'larını ekle
            ['student-class-filter', 'student-sort'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateStudentsView);
                }
            });
            
            const searchInput = document.getElementById('student-search');
            if (searchInput) {
                searchInput.addEventListener('input', updateStudentsView);
            }
        }

        // =============================================
        // DAVAMSIZLIK GÖRÜNÜMÜNÜ GÜNCELLE
        // =============================================
        function updateAttendanceView() {
            const tableBody = document.getElementById('attendance-table-body');
            tableBody.innerHTML = '';

            const classFilter = document.getElementById('attendance-class-filter').value;
            const threshold = parseInt(document.getElementById('attendance-threshold').value);

            let filteredStudents = schoolData.students;

            // Filtreleri uygula
            if (classFilter !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.className === classFilter);
            }

            // Eşik değerine göre filtrele
            filteredStudents = filteredStudents.filter(s => s.attendance >= threshold);

            // Davamsızlığa göre sırala (yüksekten düşüğe)
            filteredStudents.sort((a, b) => b.attendance - a.attendance);

            // İstatistikleri güncelle
            updateAttendanceStats(filteredStudents);

            // Tabloyu doldur
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                
                let impact = 'Aşağı';
                if (student.attendance >= 15) impact = 'Çox yüksək';
                else if (student.attendance >= 10) impact = 'Yüksək';
                else if (student.attendance >= 5) impact = 'Orta';

                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-photo me-2">
                                <img src="https://i.imgur.com/a3FuVV8.png" 
                                     alt="IMSA Logo"
                                     onerror="this.onerror=null; this.src='https://placehold.co/36x36/00525d/ffffff?text=IMSA';">
                            </div>
                            <strong>${student.name}</strong>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${student.className}</span></td>
                    <td>
                        <span class="attendance-badge ${getAttendanceClass(student.attendance)}">
                            <i class="fas fa-calendar-times me-1"></i>${student.attendance} gün
                        </span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <strong>${student.average.toFixed(1)}</strong>
                            <div class="progress progress-custom ms-2" style="width: 50px;">
                                <div class="progress-bar ${getProgressBarClass(student.average)}" 
                                     style="width: ${student.average}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getAttendanceStatusBadgeClass(student.attendanceStatus)}">
                            ${student.attendanceStatus}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${impact === 'Çox yüksək' ? 'bg-danger' : impact === 'Yüksək' ? 'bg-warning' : 'bg-info'}">
                            ${impact}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Sayacı güncelle
            document.getElementById('attendance-count').textContent = `${filteredStudents.length} şagird`;

            // Sınıf bazlı davamsızlık grafiğini güncelle
            updateClassAttendanceChart();

            // Event listener'ları ekle
            ['attendance-class-filter', 'attendance-threshold'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateAttendanceView);
                }
            });
        }

        // =============================================
        // DAVAMSIZLIK İSTATİSTİKLERİNİ GÜNCELLE
        // =============================================
        function updateAttendanceStats(students) {
            let good = 0, medium = 0, high = 0;

            students.forEach(student => {
                if (student.attendance <= 4) good++;
                else if (student.attendance <= 9) medium++;
                else high++;
            });

            document.getElementById('good-attendance-count').textContent = good;
            document.getElementById('medium-attendance-count').textContent = medium;
            document.getElementById('high-attendance-count').textContent = high;
        }

        // =============================================
        // SINIF BAZLI DAVAMSIZLIK GRAFİĞİ
        // =============================================
        function updateClassAttendanceChart() {
            const ctx = document.getElementById('classAttendanceChart').getContext('2d');
            const stats = schoolData.overallStats;

            const classNames = schoolData.classes;
            const attendanceAverages = classNames.map(className => stats.classAverages[className]?.attendance || 0);

            if (charts.classAttendanceChart) {
                charts.classAttendanceChart.destroy();
            }

            charts.classAttendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classNames,
                    datasets: [{
                        label: 'Orta Davamsızlıq (gün)',
                        data: attendanceAverages,
                        backgroundColor: attendanceAverages.map(avg => {
                            if (avg <= 3) return 'rgba(79, 209, 197, 0.7)';
                            if (avg <= 6) return 'rgba(16, 185, 129, 0.7)';
                            if (avg <= 10) return 'rgba(245, 158, 11, 0.7)';
                            return 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderColor: attendanceAverages.map(avg => {
                            if (avg <= 3) return 'rgb(79, 209, 197)';
                            if (avg <= 6) return 'rgb(16, 185, 129)';
                            if (avg <= 10) return 'rgb(245, 158, 11)';
                            return 'rgb(239, 68, 68)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Davamsızlıq (gün)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Siniflər'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // FƏNN GÖRÜNÜMÜNÜ GÜNCELLE
        // =============================================
        function updateSubjectsView() {
            const tableBody = document.getElementById('subjects-table-body');
            tableBody.innerHTML = '';

            const classFilter = document.getElementById('subject-class-filter').value;
            const gradeFilter = document.getElementById('subject-grade-filter').value;
            const sortBy = document.getElementById('subject-sort').value;

            let filteredSubjects = schoolData.subjects;
            const stats = schoolData.overallStats;

            // En iyi ve en kötü dersleri bul
            let bestSubject = '';
            let bestAvg = 0;
            let worstSubject = '';
            let worstAvg = 100;

            schoolData.subjects.forEach(subject => {
                const avg = stats.subjectAverages[subject] || 0;
                if (avg > bestAvg) {
                    bestAvg = avg;
                    bestSubject = subject;
                }
                if (avg < worstAvg) {
                    worstAvg = avg;
                    worstSubject = subject;
                }
            });

            // Kartları güncelle
            document.getElementById('best-subject').textContent = bestSubject;
            document.getElementById('worst-subject').textContent = worstSubject;
            document.getElementById('subject-total-count').textContent = filteredSubjects.length;

            // Tabloyu doldur
            filteredSubjects.forEach(subject => {
                const avg = stats.subjectAverages[subject] || 0;
                const row = document.createElement('tr');
                
                // Sınıf seviyesine göre ortalamaları hesapla
                let grade2 = '-', grade3 = '-', grade4 = '-', grade5 = '-', 
                    grade6 = '-', grade7 = '-', grade8 = '-', grade9 = '-';
                
                for (let grade = 2; grade <= 9; grade++) {
                    const gradeAvg = stats.subjectAverages[subject + '_byGrade']?.[grade];
                    if (gradeAvg !== undefined) {
                        switch(grade) {
                            case 2: grade2 = gradeAvg.toFixed(1); break;
                            case 3: grade3 = gradeAvg.toFixed(1); break;
                            case 4: grade4 = gradeAvg.toFixed(1); break;
                            case 5: grade5 = gradeAvg.toFixed(1); break;
                            case 6: grade6 = gradeAvg.toFixed(1); break;
                            case 7: grade7 = gradeAvg.toFixed(1); break;
                            case 8: grade8 = gradeAvg.toFixed(1); break;
                            case 9: grade9 = gradeAvg.toFixed(1); break;
                        }
                    }
                }

                // Başarı oranını hesapla (%50 üstü)
                const allGrades = schoolData.students.map(s => s.subjects[subject]).filter(g => !isNaN(g));
                const successRate = allGrades.length > 0 ? 
                    (allGrades.filter(g => g >= 50).length / allGrades.length * 100).toFixed(1) : '0.0';

                row.innerHTML = `
                    <td><strong>${subject}</strong></td>
                    <td><span class="badge ${getGradeBadgeClass(avg)}">${avg.toFixed(1)}</span></td>
                    <td>${grade2}</td>
                    <td>${grade3}</td>
                    <td>${grade4}</td>
                    <td>${grade5}</td>
                    <td>${grade6}</td>
                    <td>${grade7}</td>
                    <td>${grade8}</td>
                    <td>${grade9}</td>
                    <td>
                        <div class="progress progress-custom" style="height: 20px;">
                            <div class="progress-bar ${successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-primary' : 'bg-warning'}" 
                                 style="width: ${successRate}%"></div>
                        </div>
                        <small class="d-block text-center mt-1">${successRate}%</small>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Fənn qrafikini güncelle
            updateSubjectComparisonChart();

            // Event listener'ları ekle
            ['subject-class-filter', 'subject-grade-filter', 'subject-sort'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateSubjectsView);
                }
            });
        }

        // =============================================
        // FƏNN MÜQAYİSƏ GRAFİĞİ
        // =============================================
        function updateSubjectComparisonChart() {
            const ctx = document.getElementById('subjectComparisonChart').getContext('2d');
            const stats = schoolData.overallStats;

            const subjects = schoolData.subjects.slice(0, 10); // İlk 10 dersi göster
            const averages = subjects.map(subject => stats.subjectAverages[subject] || 0);

            if (charts.subjectComparisonChart) {
                charts.subjectComparisonChart.destroy();
            }

            charts.subjectComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [{
                        label: 'Ortalama',
                        data: averages,
                        backgroundColor: averages.map(avg => {
                            if (avg >= 80) return 'rgba(79, 209, 197, 0.7)';
                            if (avg >= 60) return 'rgba(0, 173, 186, 0.7)';
                            if (avg >= 50) return 'rgba(245, 158, 11, 0.7)';
                            return 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderColor: averages.map(avg => {
                            if (avg >= 80) return 'rgb(79, 209, 197)';
                            if (avg >= 60) return 'rgb(0, 173, 186)';
                            if (avg >= 50) return 'rgb(245, 158, 11)';
                            return 'rgb(239, 68, 68)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Ortalama'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // SINIF GÖRÜNÜMÜNÜ GÜNCELLE
        // =============================================
        function updateClassesView() {
            const tableBody = document.getElementById('classes-table-body');
            const topClassesList = document.getElementById('top-classes-list');
            
            tableBody.innerHTML = '';
            topClassesList.innerHTML = '';

            const stats = schoolData.overallStats;
            const classAverages = [];

            // Sınıf verilerini hazırla
            schoolData.classes.forEach(className => {
                const classData = stats.classAverages[className];
                if (classData) {
                    classAverages.push({
                        className: className,
                        average: classData.average,
                        attendance: classData.attendance,
                        studentCount: classData.studentCount
                    });
                }
            });

            // Ortalamaya göre sırala
            classAverages.sort((a, b) => b.average - a.average);

            // En iyi 3 sınıfı göster
            const topClasses = classAverages.slice(0, 3);
            topClasses.forEach((cls, index) => {
                const medal = ['🥇', '🥈', '🥉'][index];
                const classEl = document.createElement('div');
                classEl.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                classEl.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="fs-5 me-2">${medal}</span>
                        <div>
                            <strong>${cls.className}</strong><br>
                            <small class="text-muted">Ortalama: ${cls.average.toFixed(1)} | Şagird: ${cls.studentCount}</small>
                        </div>
                    </div>
                    <span class="badge ${getProgressBarClass(cls.average)}">
                        ${cls.average.toFixed(1)}
                    </span>
                `;
                topClassesList.appendChild(classEl);
            });

            // Tabloyu doldur
            classAverages.forEach(cls => {
                const classStudents = schoolData.students.filter(s => s.className === cls.className);
                
                // En iyi ve en kötü dersleri bul
                let bestSubject = '';
                let bestAvg = 0;
                let worstSubject = '';
                let worstAvg = 100;
                
                schoolData.subjects.forEach(subject => {
                    const subjectGrades = classStudents.map(s => s.subjects[subject]).filter(g => !isNaN(g));
                    if (subjectGrades.length > 0) {
                        const avg = subjectGrades.reduce((a, b) => a + b, 0) / subjectGrades.length;
                        if (avg > bestAvg) {
                            bestAvg = avg;
                            bestSubject = subject;
                        }
                        if (avg < worstAvg) {
                            worstAvg = avg;
                            worstSubject = subject;
                        }
                    }
                });

                // Başarı oranı
                const successRate = classStudents.length > 0 ? 
                    (classStudents.filter(s => s.average >= 50).length / classStudents.length * 100).toFixed(1) : '0.0';

                // Durum
                let status = 'Yaxşı';
                if (cls.average >= 80) status = 'Əla';
                else if (cls.average >= 70) status = 'Yaxşı';
                else if (cls.average >= 50) status = 'Kafi';
                else status = 'Zəif';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${cls.className}</strong></td>
                    <td>${cls.studentCount}</td>
                    <td>
                        <span class="badge ${getGradeBadgeClass(cls.average)}">
                            ${cls.average.toFixed(1)}
                        </span>
                    </td>
                    <td>
                        <span class="attendance-badge ${getAttendanceClass(cls.attendance)}">
                            ${cls.attendance.toFixed(1)} gün
                        </span>
                    </td>
                    <td>${bestSubject || '-'} (${bestAvg.toFixed(1)})</td>
                    <td>${worstSubject || '-'} (${worstAvg.toFixed(1)})</td>
                    <td>
                        <div class="progress progress-custom" style="height: 20px;">
                            <div class="progress-bar ${successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-primary' : 'bg-warning'}" 
                                 style="width: ${successRate}%"></div>
                        </div>
                        <small class="d-block text-center mt-1">${successRate}%</small>
                    </td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(status)}">
                            ${status}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Sınıf grafiğini güncelle
            updateClassAvgChart();
        }

        // =============================================
        // SINIF ORTALAMALARI GRAFİĞİ
        // =============================================
        function updateClassAvgChart() {
            const ctx = document.getElementById('classAvgChart').getContext('2d');
            const stats = schoolData.overallStats;

            const classNames = schoolData.classes;
            const averages = classNames.map(className => stats.classAverages[className]?.average || 0);
            const attendances = classNames.map(className => stats.classAverages[className]?.attendance || 0);

            if (charts.classAvgChart) {
                charts.classAvgChart.destroy();
            }

            charts.classAvgChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classNames,
                    datasets: [
                        {
                            label: 'Sinif Ortalaması',
                            data: averages,
                            backgroundColor: 'rgba(0, 82, 93, 0.7)',
                            borderColor: 'rgb(0, 82, 93)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Davamsızlıq (gün)',
                            data: attendances,
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            borderColor: 'rgb(245, 158, 11)',
                            borderWidth: 1,
                            yAxisID: 'y1',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Ortalama'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Davamsızlıq (gün)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // MÜQAYİSƏ GÖRÜNÜMÜNÜ GÜNCELLE
        // =============================================
        function updateComparisonView() {
            const tableBody = document.getElementById('comparison-table-body');
            tableBody.innerHTML = '';

            const stats = schoolData.overallStats;

            // Karşılaştırma verilerini hazırla
            const comparisonData = [
                { label: 'Ümumi Orta', values: [] },
                { label: 'Şagird Sayı', values: [] },
                { label: 'Davamsızlıq (orta)', values: [] },
                { label: 'Uğurlu Şagird (%)', values: [] },
                { label: 'Əla Nəticə (%)', values: [] }
            ];

            // Her sınıf seviyesi için verileri topla
            for (let grade = 2; grade <= 9; grade++) {
                const gradeStudents = schoolData.students.filter(s => s.gradeLevel === grade);
                
                if (gradeStudents.length > 0) {
                    // Ortalama
                    const averages = gradeStudents.map(s => s.average).filter(a => !isNaN(a));
                    const avg = averages.length > 0 ? averages.reduce((a, b) => a + b, 0) / averages.length : 0;
                    comparisonData[0].values.push(avg.toFixed(1));
                    
                    // Öğrenci sayı
                    comparisonData[1].values.push(gradeStudents.length);
                    
                    // Davamsızlık
                    const attendances = gradeStudents.map(s => s.attendance).filter(a => !isNaN(a));
                    const attAvg = attendances.length > 0 ? attendances.reduce((a, b) => a + b, 0) / attendances.length : 0;
                    comparisonData[2].values.push(attAvg.toFixed(1));
                    
                    // Başarı oranı (%50 üstü)
                    const successRate = (gradeStudents.filter(s => s.average >= 50).length / gradeStudents.length * 100).toFixed(1);
                    comparisonData[3].values.push(successRate);
                    
                    // Mükemmel oranı (%85 üstü)
                    const excellentRate = (gradeStudents.filter(s => s.average >= 85).length / gradeStudents.length * 100).toFixed(1);
                    comparisonData[4].values.push(excellentRate);
                } else {
                    // Veri yoksa boş değerler
                    comparisonData.forEach(data => data.values.push('-'));
                }
            }

            // Tabloyu doldur
            comparisonData.forEach(rowData => {
                const row = document.createElement('tr');
                let cells = `<td><strong>${rowData.label}</strong></td>`;
                
                // En yüksek değeri bul
                let maxValue = -1;
                let maxIndex = -1;
                
                if (rowData.label !== 'Şagird Sayı') {
                    rowData.values.forEach((value, index) => {
                        if (value !== '-' && parseFloat(value) > maxValue) {
                            maxValue = parseFloat(value);
                            maxIndex = index;
                        }
                    });
                }

                // Hücreleri oluştur
                rowData.values.forEach((value, index) => {
                    let cellClass = '';
                    if (index === maxIndex && maxIndex !== -1) {
                        cellClass = 'bg-success text-white';
                    }
                    cells += `<td class="${cellClass}">${value}</td>`;
                });

                // Kazanan sınıfı ekle
                let winnerClass = '-';
                if (maxIndex !== -1) {
                    winnerClass = `${maxIndex + 2}-ci sinif`;
                }
                cells += `<td><span class="badge bg-success">${winnerClass}</span></td>`;

                row.innerHTML = cells;
                tableBody.appendChild(row);
            });

            // Grafikleri güncelle
            updateGradeComparisonChart();
            updateAttendanceCorrelationChart();
        }

        // =============================================
        // SINIF SEVİYESİ KARŞILAŞTIRMA GRAFİĞİ
        // =============================================
        function updateGradeComparisonChart() {
            const ctx = document.getElementById('gradeComparisonChart').getContext('2d');
            const stats = schoolData.overallStats;

            const grades = [2, 3, 4, 5, 6, 7, 8, 9];
            const averages = grades.map(grade => stats.gradeAverages[grade] || 0);

            if (charts.gradeComparisonChart) {
                charts.gradeComparisonChart.destroy();
            }

            charts.gradeComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grades.map(g => `${g}-ci sinif`),
                    datasets: [{
                        label: 'Ortalama',
                        data: averages,
                        backgroundColor: averages.map(avg => {
                            if (avg >= 80) return 'rgba(79, 209, 197, 0.7)';
                            if (avg >= 70) return 'rgba(0, 173, 186, 0.7)';
                            if (avg >= 60) return 'rgba(245, 158, 11, 0.7)';
                            return 'rgba(239, 68, 68, 0.7)';
                        }),
                        borderColor: averages.map(avg => {
                            if (avg >= 80) return 'rgb(79, 209, 197)';
                            if (avg >= 70) return 'rgb(0, 173, 186)';
                            if (avg >= 60) return 'rgb(245, 158, 11)';
                            return 'rgb(239, 68, 68)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Ortalama'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sinif Səviyyəsi'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // DAVAMSIZLIK VE ORTALAMA İLİŞKİSİ GRAFİĞİ
        // =============================================
        function updateAttendanceCorrelationChart() {
            const ctx = document.getElementById('attendanceCorrelationChart').getContext('2d');

            // Öğrencilerin davamsızlık ve ortalama verilerini al
            const dataPoints = schoolData.students.map(student => ({
                x: student.attendance,
                y: student.average
            }));

            if (charts.attendanceCorrelationChart) {
                charts.attendanceCorrelationChart.destroy();
            }

            charts.attendanceCorrelationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Şagirdlər',
                        data: dataPoints,
                        backgroundColor: 'rgba(0, 82, 93, 0.6)',
                        borderColor: 'rgb(0, 82, 93)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const student = schoolData.students.find(s => 
                                        s.attendance === context.parsed.x && 
                                        Math.abs(s.average - context.parsed.y) < 0.1
                                    );
                                    return student ? 
                                        `${student.name}: ${context.parsed.y.toFixed(1)} orta, ${context.parsed.x} gün` :
                                        `${context.parsed.y.toFixed(1)} orta, ${context.parsed.x} gün`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Davamsızlıq (gün)'
                            },
                            beginAtZero: true
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Ortalama'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // =============================================
        // YARDIMCI FONKSİYONLAR
        // =============================================
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Əla': return 'bg-success';
                case 'Yaxşı': return 'bg-primary';
                case 'Kafi': return 'bg-warning';
                case 'Zəif': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getAttendanceClass(attendance) {
            if (attendance === 0) return 'attendance-excellent';
            if (attendance <= 4) return 'attendance-good';
            if (attendance <= 9) return 'attendance-medium';
            return 'attendance-low';
        }

        function getAttendanceStatusBadgeClass(status) {
            switch (status) {
                case 'Mükəmməl': return 'bg-success';
                case 'Yaxşı': return 'bg-primary';
                case 'Orta': return 'bg-warning';
                case 'Yüksək': return 'bg-danger';
                case 'Təhlükəli': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }

        function getProgressBarClass(value) {
            if (value >= 80) return 'bg-success';
            if (value >= 60) return 'bg-primary';
            if (value >= 50) return 'bg-warning';
            return 'bg-danger';
        }

        function getGradeBadgeClass(grade) {
            if (grade >= 90) return 'bg-success';
            if (grade >= 80) return 'bg-primary';
            if (grade >= 70) return 'bg-info';
            if (grade >= 60) return 'bg-warning';
            if (grade >= 50) return 'bg-secondary';
            return 'bg-danger';
        }

        // =============================================
        // ÖĞRENCİ DETAYLARINI GÖSTER
        // =============================================
        function viewStudentDetails(studentId) {
            const student = schoolData.students.find(s => s.id === studentId);
            if (!student) return;

            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            document.getElementById('studentModalTitle').textContent = student.name;

            // Öğrenci detaylarını oluştur
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="student-photo mx-auto" style="width: 100px; height: 100px;">
                            <img src="https://i.imgur.com/a3FuVV8.png" 
                                 alt="IMSA Logo"
                                 onerror="this.onerror=null; this.src='https://placehold.co/100x100/00525d/ffffff?text=IMSA';">
                        </div>
                        <h4 class="mt-3">${student.name}</h4>
                        <span class="badge bg-primary fs-6">${student.className}</span>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>Ümumi Orta</h5>
                                        <h2 class="${getTextColorClass(student.average)}">${student.average.toFixed(1)}</h2>
                                        <span class="badge ${getStatusBadgeClass(student.status)} fs-6">
                                            ${student.status}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>Davamsızlıq</h5>
                                        <h2 class="${student.attendance <= 4 ? 'text-success' : student.attendance <= 9 ? 'text-warning' : 'text-danger'}">${student.attendance}</h2>
                                        <span class="badge ${getAttendanceStatusBadgeClass(student.attendanceStatus)} fs-6">
                                            ${student.attendanceStatus}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>Fənn Sayı</h5>
                                        <h2>${Object.keys(student.subjects).length}</h2>
                                        <small>Qiymət verilən</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h5><i class="fas fa-book me-2"></i>Fənn Qiymətləri</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Fənn</th>
                                <th>Qiymət</th>
                                <th>Status</th>
                                <th>Qrafik</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ders satırlarını ekle
            Object.entries(student.subjects).forEach(([subject, grade]) => {
                detailsHTML += `
                    <tr>
                        <td>${subject}</td>
                        <td>
                            <span class="badge ${getGradeBadgeClass(grade)} fs-6">
                                ${grade}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${grade >= 50 ? 'bg-success' : 'bg-danger'}">
                                ${grade >= 50 ? 'Uğurlu' : 'Uğursuz'}
                            </span>
                        </td>
                        <td>
                            <div class="progress progress-custom">
                                <div class="progress-bar ${getProgressBarClass(grade)}" 
                                     style="width: ${grade}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            detailsHTML += `
                        </tbody>
                    </table>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-trophy text-success me-2"></i>Ən Yaxşı Ortalamalı Fənn</h6>
                                <h4>${student.bestSubject}</h4>
                                <span class="badge bg-success fs-5">${student.bestGrade}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-exclamation-triangle text-danger me-2"></i>Ən Aşağı Ortalamalı Fənn</h6>
                                <h4>${student.worstSubject}</h4>
                                <span class="badge bg-danger fs-5">${student.worstGrade}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert ${student.attendance >= 10 ? 'alert-warning' : 'alert-info'} mt-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Tövsiyələr</h6>
                    <p class="mb-0">
                        ${getStudentRecommendations(student)}
                    </p>
                </div>
            `;

            document.getElementById('studentModalBody').innerHTML = detailsHTML;
            modal.show();
        }

        function getStudentRecommendations(student) {
            let recommendations = [];
            
            if (student.average < 50) {
                recommendations.push(`${student.worstSubject} fənnində xüsusi diqqət yetirin.`);
            }
            
            if (student.attendance >= 5) {
                recommendations.push(`Davamsızlığınız (${student.attendance} gün) nəzərə alınmalıdır.`);
            }
            
            if (student.average >= 85 && student.attendance <= 4) {
                recommendations.push(`Əla nəticə! Davam edin.`);
            }
            
            if (recommendations.length === 0) {
                return "Şagirdin performansı qənaətbəxşdir. Davam etsin.";
            }
            
            return recommendations.join(' ');
        }

        function getTextColorClass(value) {
            if (value >= 80) return 'text-success';
            if (value >= 60) return 'text-primary';
            if (value >= 50) return 'text-warning';
            return 'text-danger';
        }

        // =============================================
        // İHRAC FONKSİYONLAR
        // =============================================
        function exportPDF() {
            alert('PDF ixracı hazırlanır...');
        }

        function exportExcel() {
            try {
                // Analiz çalışma sayfası oluştur
                const analysisData = [
                    ['IMSA Məktəbi - Analiz Raporu'],
                    ['Rapor tarixi:', new Date().toLocaleDateString('az-AZ')],
                    ['Ümumi şagird sayı:', schoolData.students.length],
                    ['Sinif sayı:', schoolData.classes.length],
                    ['Fənn sayı:', schoolData.subjects.length],
                    ['Ümumi ortalama:', schoolData.overallStats.overallAverage.toFixed(2)],
                    ['Orta davamsızlıq:', schoolData.overallStats.averageAttendance.toFixed(2)],
                    [],
                    ['Davamsızlq Statistikası'],
                    ['Kateqoriya', 'Şagird sayı', 'Faiz']
                ];

                // Davamsızlık istatistiklerini ekle
                const attendanceStats = schoolData.overallStats.attendanceStats;
                const total = schoolData.students.length;
                
                analysisData.push(['Mükəmməl (0 gün)', attendanceStats.excellent, ((attendanceStats.excellent/total)*100).toFixed(2) + '%']);
                analysisData.push(['Yaxşı (1-4 gün)', attendanceStats.good, ((attendanceStats.good/total)*100).toFixed(2) + '%']);
                analysisData.push(['Orta (5-9 gün)', attendanceStats.medium, ((attendanceStats.medium/total)*100).toFixed(2) + '%']);
                analysisData.push(['Yüksək (10-14 gün)', attendanceStats.high, ((attendanceStats.high/total)*100).toFixed(2) + '%']);
                analysisData.push(['Təhlükəli (15+ gün)', attendanceStats.dangerous, ((attendanceStats.dangerous/total)*100).toFixed(2) + '%']);

                analysisData.push([], ['Sinif Statistikası']);
                analysisData.push(['Sinif', 'Şagird sayı', 'Ortalama', 'Davamsızlıq (orta)', 'Uğur nisbəti (%)']);

                // Sınıf istatistiklerini ekle
                schoolData.classes.forEach(className => {
                    const classStudents = schoolData.students.filter(s => s.className === className);
                    const average = calculateAverage(classStudents.map(s => s.average));
                    const attendanceAvg = calculateAverage(classStudents.map(s => s.attendance));
                    const successRate = (classStudents.filter(s => s.average >= 50).length / classStudents.length * 100);

                    analysisData.push([
                        className,
                        classStudents.length,
                        average.toFixed(2),
                        attendanceAvg.toFixed(2),
                        successRate.toFixed(2)
                    ]);
                });

                analysisData.push([], ['Fənn Statistikası']);
                analysisData.push(['Fənn', 'Ümumi orta', 'Ən yüksək', 'Ən aşağı', 'Uğur nisbəti (%)']);

                // Ders istatistiklerini ekle
                schoolData.subjects.forEach(subject => {
                    const grades = schoolData.students.map(s => s.subjects[subject]).filter(g => !isNaN(g));
                    
                    if (grades.length > 0) {
                        const average = calculateAverage(grades);
                        const max = Math.max(...grades);
                        const min = Math.min(...grades);
                        const successRate = (grades.filter(g => g >= 50).length / grades.length * 100);

                        analysisData.push([
                            subject,
                            average.toFixed(2),
                            max,
                            min,
                            successRate.toFixed(2)
                        ]);
                    }
                });

                // Çalışma kitabı oluştur
                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.aoa_to_sheet(analysisData);
                const ws2 = XLSX.utils.json_to_sheet(schoolData.students.map(s => ({
                    'Şagird': s.name,
                    'Sinif': s.className,
                    'Davamsızlıq (gün)': s.attendance,
                    'Ümumi orta': s.average.toFixed(2),
                    'Status': s.status,
                    ...s.subjects
                })));

                XLSX.utils.book_append_sheet(wb, ws1, 'Analiz');
                XLSX.utils.book_append_sheet(wb, ws2, 'Şagirdlər');

                // Dosyayı kaydet
                XLSX.writeFile(wb, `IMSA_Mektebi_Raporu_${new Date().toISOString().slice(0, 10)}.xlsx`);

                alert('Excel faylı uğurla yükləndi!');

            } catch (error) {
                alert('Excel ixracı zamanı xəta: ' + error.message);
            }
        }

        function exportCharts() {
            alert('Qrafiklərin ixracı hazırlanır...');
        }

        function printStudentReport() {
            window.print();
        }

        function calculateAverage(values) {
            const validValues = values.filter(v => !isNaN(v));
            if (validValues.length === 0) return 0;
            return validValues.reduce((a, b) => a + b, 0) / validValues.length;
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
